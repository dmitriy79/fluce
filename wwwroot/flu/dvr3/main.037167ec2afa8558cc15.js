!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.DvrPlayer=t():e.DvrPlayer=t()}(this,(function(){return(this.webpackJsonpDvrPlayer=this.webpackJsonpDvrPlayer||[]).push([[0],{174:function(e,t,n){e.exports=n.p+"a47439acd0ea182352fd59dc41ff2b2e.swf"},529:function(e,t,n){},530:function(e,t,n){"use strict";n.r(t);n(176),n(503),n(504);var a=n(1),r=n.n(a),i=n(56),o=n.n(i),s=n(0),l=n.n(s),u=n(76),h=n(14),c=n.n(h),p=new RegExp("{([a-zA-Z]+)}","ig");function d(e,t){return e?t?e.replace(p,(function(e,n){return void 0!==t[n]?t[n]:e})):e:""}function m(e){return 3600*Math.floor(e/3600)}function f(e,t){var n=e+"";return"00000000000000000000".slice(0,t-n.length)+n}function g(e){return e<=9?"0"+e:e}function v(e,t){t=null==t||t;if(!(e>0))return"";var n=new Date;n.setTime(1e3*e);var a=!(!1===t),r=a?n.getHours():n.getUTCHours(),i=a?n.getMinutes():n.getUTCMinutes(),o=a?n.getSeconds():n.getUTCSeconds();return g(r)+":"+g(i)+":"+g(o)}function y(e,t){t=null==t||t;if(!(e>0))return"";var n=new Date;n.setTime(Math.round(1e3*e));var a=!(!1===t),r=a?n.getDate():n.getUTCDate(),i=(a?n.getMonth():n.getUTCMonth())+1;return f(a?n.getFullYear():n.getUTCFullYear(),4)+"."+g(i)+"."+g(r)}function b(e){var t=new Date,n=new Date;return t.setTime(1e3*e),n.setTime(1e3*e),t.setHours(0,0,0,0),n.setHours(23,59,59,999),{start:t.getTime()/1e3,end:n.getTime()/1e3}}function _(e,t){var n=e.start<t.start?e:t,a=n===e?t:e;return!(n.end<a.start)&&{start:a.start,end:n.end<a.end?n.end:a.end}}Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if(null==e)throw new TypeError("Cannot convert first argument to object");for(var n=Object(e),a=1;a<arguments.length;a++){var r=arguments[a];if(null!=r)for(var i=Object.keys(Object(r)),o=0,s=i.length;o<s;o++){var l=i[o],u=Object.getOwnPropertyDescriptor(r,l);void 0!==u&&u.enumerable&&(n[l]=r[l])}}return n}}),Math.trunc||(Math.trunc=function(e){return e=+e,isFinite(e)?e-e%1||(e<0?-0:0===e?e:0):e}),Int8Array.__proto__&&!Int8Array.__proto__.from&&(Int8Array.__proto__.from=function(e,t,n){var a=Int8Array.__proto__;if("function"!=typeof this)throw new TypeError("# is not a constructor");if(this.__proto__!==a)throw new TypeError("this is not a typed array.");if("function"!=typeof(t=t||function(e){return e}))throw new TypeError("specified argument is not a function");if(!(e=Object(e)).length)return new this(0);for(var r=[],i=0;i<e.length;i++)r.push(e[i]);var o=new this((r=r.map(t,n)).length);for(i=0;i<o.length;i++)o[i]=r[i];return o});var S={mergeRanges:function(e,t){var n=[],a=[],r={},i=0,o=e.length,s=t.length;if(0===s)return e;for(;i<o;){for(var l=e[i].from,u=l+e[i].duration,h=0;h<s;){var c=t[h].from;g(l,u,c,c+t[h].duration)&&(n.push(i),a.push(h),r[i]=h),h++}i++}var p=n.map((function(n){var a=Math.min(e[n].from,t[r[n]].from);return{from:a,duration:Math.max(e[n].from+e[n].duration,t[r[n]].from+t[r[n]].duration)-a}})),d=e.filter((function(e,t){return-1===n.indexOf(t)})),m=t.filter((function(e,t){return-1===a.indexOf(t)})),f=d.concat(p,m);return f.sort((function(e,t){return e.from+e.duration<t.from+t.duration?-1:e.from+e.duration>t.from+t.duration?1:0})),f;function g(e,t,n,a){return e<=n&&t>=n||n<e&&a>=e}},diff:function(){for(var e,t,n,a,r,i,o,s=[].slice.call(arguments,0),l=s.length,u=s[0],h={},c=1;c<l;c++)for(e=s[c],n=(t=Object.keys(e)).length,r=0;r<n;r++)a=t[r],i=e[a],o=u[a],i!==o&&(h[a]=e[a]);return h},isFlashAvailable:function(){return-1!=window.navigator.userAgent.indexOf("MSIE ")},substitute:d,makeAppOpts:function(e){var t=window.location.search.substring(1).split("&").map((function(e){return e.split("=")})).reduce((function(e,t){return e[decodeURIComponent(t[0])]=decodeURIComponent(t[1]),e}),{}),n=parseInt(t.play_duration,10),a=t.autoplay,r={name:e.name,streamer_http:window.location.protocol+"//"+window.location.host,thumbnails_enabled:e.thumbnails_enabled,from:t.from?parseInt(t.from):null,zoom:t.zoom?parseInt(t.zoom):null,proto:t.proto,locale:t.locale||"en",debug:"true"==t.debug,play_duration:n&&!isNaN(n)?n:null,tracks:t.tracks,autoPlay:!a||"true"==a},i=t[e.auth_token];i&&(r.auth_token=e.auth_token+"="+i);var o=parseInt(e.rtmp_port,10);return o>0&&(r.streamer_rtmp="rtmp://"+window.location.hostname+":"+o),r},hour:m,setMinimalRange:function(e,t){return{from:m(e),to:m(t+3600)}},now:function(){return Math.round((new Date).getTime()/1e3)},floorToHour:function(e){return 3600*Math.floor(e/3600)},pad:f,pad2:g,humanTime:v,humanDate:y,throttle:function(e,t){var n,a,r=!1;return function i(){if(r)return n=arguments,void(a=this);e.apply(this,arguments),r=!0,setTimeout((function(){r=!1,n&&a&&(i.apply(a,n),a=n=void 0)}),t)}},utc_to_relative:function(e,t,n){if(!n)return 0;for(var a=0,r=0;r<n.length&&!(n[r].from+n[r].duration>=t);r++);if(r>=n.length)return 0;if(n[r].from<t&&n[r].from+n[r].duration>=e)return e-t;if(n[r].from<t&&(a+=n[r].from+n[r].duration-t,r++),r>=n.length)return e-t;for(;r<n.length&&n[r].from<t+3600;r++){if(n[r].from<=e&&e<=n[r].from+n[r].duration)return a+e-n[r].from;a+=n[r].duration}return a},getFirstHourSegmentIndex:function(e,t){for(var n=0,a=e.length;n<a&&!(e[n].from+e[n].duration>=t);n++);return(n>=a||n<a&&t>e[n].from+e[n].duration)&&(n=-1),n},utcToRelative:function(e,t,n){if(console.log("*",JSON.stringify(n)),console.log("*",t),console.log({utc:e,h:t,s:n}),Math.trunc(e/3600)!==t/3600)throw new Error("utc should be into h");if(e<t)throw new Error("utc should be gt h");var a=this.getFirstHourSegmentIndex(n,t);if(-1===a)throw new Error("no segments to play");var r=t;n[a]&&n[a].from>t&&(r=n[a].from);for(var i=r,o=void 0,s=void 0,l=n.length,u=0;a<l&&(o=n[a].from,s=n[a].duration,!(o>e));){if(e<=o+s){i=e;break}if(a+1<l&&e>o+s&&e<n[a+1].from)return void console.error("you click to empty range");a+1<l&&e>n[a+1].from&&(i=n[a+1].from,u+=n[a+1].from-(o+s)),a++}return i-r-u},relativeToUtc:function(e,t,n){for(var a=t,r=0;r<n.length&&!(n[r].from+n[r].duration>=e);)r++;if(r>=n.length)return e+t;if(n[r].from<=e&&n[r].from+n[r].duration>=e){if(e+t<=n[r].from+n[r].duration)return e+t;a-=n[r].duration-(e-n[r].from),r++}for(;r<n.length;){if(a<=n[r].duration)return n[r].from+a;if(++r>=n.length||!n[r])break;a-=n[r].duration}return e+t},getDayRangeByUtc:b,isInRange:function(e,t){for(var n,a,r=t.length,i=0;i<r;){if(n=t[i].from,a=t[i].duration,e<n)return!1;if(e>n+a)i++;else{if(e>=n&&e<=n+a)return!0;i++}}return!1},intersection:_,getNearLeftFrom:function(e,t){for(var n,a,r=t.length,i=0;i<r;){if(n=t[i].from,a=t[i].duration,e<n)return n;if(e>n+a)i++;else{if(e>=n&&e<=n+a)return e;i++}}return"live"},currentUrl:function(e,t){var n=new URL(e),a=Object(u.parse)(n.search.replace(/^\?/,"")),r=c()(a,{$merge:t});return n.search=Object(u.stringify)(r),n.toString()}},T=function(){return r.a.createElement("div",{className:"spinnerThreeBounce"},r.a.createElement("div",{className:"bounce bounce1"}),r.a.createElement("div",{className:"bounce bounce2"}),r.a.createElement("div",{className:"bounce bounce3"}))},w=n(19),k=n.n(w),E=n(171),R=n.n(E),M=n(47),C=n.n(M),D=n(172),P=n.n(D),O=n(173);var U=function(e,t,n){var a;return function(){var r=this,i=arguments,o=function(){a=null,n||e.apply(r,i)},s=n&&!a;clearTimeout(a),a=setTimeout(o,t),s&&e.apply(r,i)}};function N(e){return(N="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function L(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function x(e){return(x=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function j(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function I(e,t){return(I=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function B(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var F=function(e){function t(){var e,n,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=this,a=x(t).call(this),e=!a||"object"!==N(a)&&"function"!=typeof a?j(n):a,B(j(e),"setSnapshotRef",(function(t){!e.snapshotRef&&t&&(e.snapshotRef=t)})),e.setStateSafe=e.setStateSafe.bind(j(e)),e.playEnded=e.playEnded.bind(j(e)),e.getMetadata=e.getMetadata.bind(j(e)),e.changeSpeed=e.changeSpeed.bind(j(e)),e.play=U(e.play.bind(j(e)),300),e.playerStop=e.playerStop.bind(j(e)),e.destroyHls=e.destroyHls.bind(j(e)),e.startLivePlayback=e.startLivePlayback.bind(j(e)),e.startByTimePlayback=e.startByTimePlayback.bind(j(e)),e.handleManifestParsed=e.handleManifestParsed.bind(j(e)),e.handleHlsFragChanged=e.handleHlsFragChanged.bind(j(e)),e.shortSeekTo=e.shortSeekTo.bind(j(e)),e.onMediaInfo=e.onMediaInfo.bind(j(e)),e.onMBRTrackChange=e.onMBRTrackChange.bind(j(e)),e.handleFullScreen=e.handleFullScreen.bind(j(e)),e.handleTouchEnd=e.handleTouchEnd.bind(j(e)),e.handlePause=e.handlePause.bind(j(e)),e.takeSnapshot=e.takeSnapshot.bind(j(e)),e.setSnapshotRef=e.setSnapshotRef.bind(j(e)),e.startTimeUpdateTimer=e.startTimeUpdateTimer.bind(j(e)),e.stopTimeUpdateTimer=e.stopTimeUpdateTimer.bind(j(e)),e.onTimeUpdate=e.onTimeUpdate.bind(j(e)),e.calculatePos=e.calculatePos.bind(j(e)),e.getWrapperWidth=e.getWrapperWidth.bind(j(e)),e.resetZoom=e.resetZoom.bind(j(e)),e.refreshZoom=U(e.refreshZoom.bind(j(e)),150),e.state={tracks:[],streams:[],videoStream:{},audioStream:{},ranges:null,utc_timer:void 0,noLive:!1,shouldStartPlay:!1,snapshotTime:null,wrapperDisplay:"flex",scale:1},e.timeout=null,e.lastTap=0,e.isUnmounted=!0,e}var n,a,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&I(e,t)}(t,e),n=t,(a=[{key:"componentDidMount",value:function(){var e=this;this._video.addEventListener("ended",this.playEnded,!1),this.props.debug&&(this._video.addEventListener("pause",(function(e){console.trace("paused !!!",e)})),this._video.addEventListener("play",(function(e){console.log("player play",e)})),this._video.addEventListener("emptied",(function(e){console.log("emptied",e)})),this._video.addEventListener("loadstart",(function(e){console.log("loadstart",e)}))),this._video.addEventListener("touchend",this.handleTouchEnd),this.isUnmounted=!1,this.zoomElement=P()(this._video,{maxZoom:10,minZoom:1,smoothScroll:!1,filterKey:function(){return!0}}),this.zoomElement.on("transform",(function(t){e.calculatePos(t)})),window.addEventListener("resize",(function(){e.refreshZoom()}))}},{key:"componentWillReceiveProps",value:function(e){var t=this.props.currentTime,n=e.currentTime;t&&t!==n&&(this.setStateSafe({noLive:!1}),this.setStateSafe({shouldStartPlay:!0})),t!==n&&(this.playerStop(),this.play(n)),e.currentRanges&&e.currentRanges.ranges&&JSON.stringify(this.state.ranges)!==JSON.stringify(e.currentRanges.ranges)&&this.setStateSafe({ranges:e.currentRanges.ranges}),this.props.playback_speed!==e.playback_speed&&this.changeSpeed(e.playback_speed),this.props.paused!==e.paused&&this.handlePause()}},{key:"componentWillUnmount",value:function(){this._video&&(this._video.removeEventListener("ended",this.playEnded,!1),this._video.removeEventListener("touchend",this.handleTouchEnd)),this.stopTimeUpdateTimer(),this.player&&this.player.stop(),this.destroyHls(),this.isUnmounted=!0,this.zoomElement&&this.zoomElement.dispose(),window.removeEventListener("resize")}},{key:"setStateSafe",value:function(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];this.isUnmounted?(e=console).log.apply(e,["DVRMsePlayer's setState called for unmounted component with args: "].concat(n)):this.setState.apply(this,n)}},{key:"playEnded",value:function(){this.state.snapshotTime&&"live"!==!this.props.currentTime&&this.state.snapshotTime>=Math.round((new Date).getTime()/1e3)-50?(console.log("switch to live"),this.props.returnData("currentTime","live")):this.state.snapshotTime&&(console.log("overlap to next second"),this.props.returnData("currentTime",Math.round(this.state.snapshotTime)+1))}},{key:"handleTouchEnd",value:function(e){var t=this,n=(new Date).getTime(),a=n-this.lastTap;clearTimeout(this.timeout),a<500&&a>0?(e.preventDefault(),this.handleFullScreen()):this.timeout=setTimeout((function(){clearTimeout(t.timeout)}),500),this.lastTap=n}},{key:"getMetadata",value:function(){return{width:this._video.videoWidth,height:this._video.videoHeight}}},{key:"setTracks",value:function(e){this.state.live&&this.player&&this.player.setTracks(e)}},{key:"changeSpeed",value:function(e){this.hls&&this._video&&(this._video.playbackRate=e)}},{key:"play",value:function(e){if(this.props.debug&&console.log("[dvr]: play",e),e){this.playRun=!0;var t=function(){this._video&&this._video.removeEventListener("emptied",t),this.player=void 0,"live"===e?this.props.hls?this.startByTimePlayback(e):this.startLivePlayback(e):(this._video&&this._video.pause(),this.startByTimePlayback(e))}.bind(this);this.player||this.hls?(this.playerStop(),this._video.addEventListener("emptied",t)):t()}}},{key:"playerStop",value:function(){this.destroyHls(),this.player&&this.player.stop()}},{key:"destroyHls",value:function(){this.hls&&(this.hls.destroy(),delete this.hls)}},{key:"startLivePlayback",value:function(e){var t=this;this.props.returnData("isStalling",!0),this.stopTimeUpdateTimer();var n=this.state.tracks.length?"tracks="+this.state.tracks:"",a=this.props.streamer_http.replace(/^http/,"ws")+"/"+this.props.name+"/mse_ld?"+[this.props.auth_token,n].filter((function(e){return e})).join("&");this.destroyHls(),this.player=new R.a(this._video,a,{debug:this.props.debug,connectionRetries:1,onProgress:function(e,t){(0,this.props.returnData)("playerProgressTime",e),this.setStateSafe({snapshotTime:e}),this.setStateSafe({noLive:!1});var n=this.props.play_duration;!this.playDurationOnce&&n>0&&this.state.pause}.bind(this),onDisconnect:function(e){console.log("Websocket status:",e)},onError:function(e){console.log("••••• ERRROR",e),e.error&&"play_promise_reject"===e.error&&(t.player.stop(),t.setStateSafe({noLive:!0}),t.props.returnData("isStalling",!1))}}),this.setStateSafe({url:a,pause:!1}),this.props.returnData("live",!0),this.props.returnData("playback_speed",1),this.player.onMediaInfo=this.onMediaInfo,this.player.play(e).then((function(){t.props.returnData("isStalling",!1)})).catch((function(e){t.props.returnData("isStalling",!1),t.player&&t.player.stop(),t.props.debug&&console.log("Nothing to play")}))}},{key:"startByTimePlayback",value:function(e){var t=this;this._video&&this._video.pause(),this.props.returnData("isStalling",!0);var n="live"===e,a=S.hour(e);this.stopTimeUpdateTimer();var r,i=this.getPlayListUrl(e,void 0,n);this.setStateSafe({url:i}),this.setStateSafe({pause:!1}),n||this.props.returnData("live",!1),this.destroyHls(),this.hls=new C.a(Object.assign({},{maxMaxBufferLength:60},r)),this.hls.attachMedia(this._video),this.hls.on(C.a.Events.MEDIA_ATTACHED,(function(){t.hls.loadSource(i),t.hls.on(C.a.Events.MANIFEST_PARSED,t.handleManifestParsed)})),n&&this.hls.on(C.a.Events.FRAG_CHANGED,this.handleHlsFragChanged),this.hls.on(C.a.Events.ERROR,(function(a,r){var i=r.type,o=r.details,s=r.fatal;if(console.log({event:a,errorType:i,errorDetails:o,errorFatal:s}),s)switch(i){case C.a.ErrorTypes.NETWORK_ERROR:console.log("fatal network error encountered, try to recover"),n?(t.setStateSafe({noLive:!0}),t.props.returnData("isStalling",!1),t.hls.destroy()):t.props.returnData("currentTime",e+1);break;case C.a.ErrorTypes.MEDIA_ERROR:console.log("fatal media error encountered, try to recover"),t.hls.recoverMediaError();break;default:t.hls.destroy()}}));var o=this;this._video&&(this._video.ondurationchange=function(){o.seekTo&&(this.ondurationchange=null,!n&&this.hls&&o.shortSeekTo(o.seekTo),delete o.seekTo)}),n&&this.props.returnData("live",!0),this.hour=a,this.seekTo=e,this._video.playbackRate=this.props.playback_speed,!n&&this.startTimeUpdateTimer()}},{key:"getPlayListUrl",value:function(e,t,n){return t=t||3600,this._getPlayListUrl(this.props.streamer_http,this.props.name,e,t,this.props.auth_token,n)}},{key:"_getPlayListUrl",value:function(e,t,n,a,r,i){return e+"/"+t+"/index"+"".concat(i?"":"-"+n+"-"+a)+".m3u8"+(r?"?"+r:"")}},{key:"handleManifestParsed",value:function(){var e=this,t=this._video.play();void 0!==t&&t.then((function(){e.props.returnData("isStalling",!1)})).catch((function(t){throw e.playRun=!1,e.hls.recoverMediaError(),e.props.returnData("isStalling",!1),new Error(t)}))}},{key:"handleHlsFragChanged",value:function(e,t){var n=/(\d{4})\/(\d{2})\/(\d{2})\/(\d{2})\/(\d{2})\/(\d{2})-(\d{5})/.exec(t.frag._url),a=new Date;a.setUTCFullYear(parseInt(n[1],10)),a.setUTCMonth(parseInt(n[2],10)-1),a.setUTCDate(parseInt(n[3],10)),a.setUTCHours(parseInt(n[4],10)),a.setUTCMinutes(parseInt(n[5],10)),a.setUTCSeconds(parseInt(n[6],10)),this.lastSeenDts=t.frag.endDTS,this.lastSeenTime=a.getTime(),this.setState({snapshotTime:Math.round(a.getTime()/1e3)}),this.props.returnData("playerProgressTime",a.getTime()/1e3+(this.lastSeenDts-this._video.currentTime))}},{key:"shortSeekTo",value:function(e){if(this._video)try{var t=e,n=this.hour,a=this.state.ranges,r=this._video.buffered.length>0?Math.round(this._video.buffered.start(0)):1,i=S.utcToRelative(t,n,a)+r;console.log("*",i),this._video.currentTime=i}catch(e){throw new Error(e)}}},{key:"relativeToUtc",value:function(e){return this.state.live?void 0:S.relativeToUtc(this.hour,e,this.state.ranges)}},{key:"onMediaInfo",value:function(e){var t={streams:e.streams},n=e.tracks||e.streams,a=n.find((function(e){return"v"===e.track_id.charAt(0)}));t.videoStream=a||"";var r=n.find((function(e){return"a"===e.track_id.charAt(0)}));t.audioStream=r||"",this.setStateSafe(t),this.props.onMediaInfo&&"function"==typeof this.props.onMediaInfo&&this.props.onMediaInfo(e)}},{key:"isVideoContent",value:function(e){return"video"===e.content}},{key:"isAudioContent",value:function(e){return"audio"===e.content}},{key:"onMBRTrackChange",value:function(e){var t=this.isVideoContent(e)?e:this.state.videoStream,n=this.isAudioContent(e)?e:this.state.audioStream,a=[t.track_id,n.track_id],r=B({tracks:a,videoStream:t,audioStream:n},"videoStream",t);this.setTracks(a),this.setStateSafe(r)}},{key:"handleFullScreen",value:function(){var e,t=this._video;e=t,document.fullscreen?document.exitFullscreen():e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen?e.msRequestFullscreen():e.webkitEnterFullScreen&&e.webkitEnterFullScreen()}},{key:"handlePause",value:function(){var e=this.props.paused,t="live"===this.props.currentTime;t&&this.player&&(e?(this.player.play(),e=!1):(this.player.pause(),e=!0)),!t&&this.hls&&(e?(this._video.play(),e=!1):(this._video.pause(),e=!0))}},{key:"takeSnapshot",value:function(){var e=this,t=this.snapshotRef,n=this._video,a=t.getContext("2d"),r=n.videoWidth,i=n.videoHeight;return t.width=r,t.height=i,a.fillRect(0,0,r,i),a.drawImage(n,0,0,r,i),new Promise((function(n,a){t.toBlob((function(t){if(!t)return a();Object(O.saveAs)(t,"snapshot_".concat(e.state.snapshotTime,".png")),n()}))}))}},{key:"startTimeUpdateTimer",value:function(){var e=this;this.timeUpdateTimer||(this.timeUpdateTimer=setInterval((function(){e.onTimeUpdate()}),100))}},{key:"stopTimeUpdateTimer",value:function(){this.timeUpdateTimer&&(clearInterval(this.timeUpdateTimer),this.timeUpdateTimer=null)}},{key:"onTimeUpdate",value:function(){var e=this.props.currentTime+this._video.currentTime;this.setState({snapshotTime:e}),this.props.returnData("playerProgressTime",e)}},{key:"getWrapperWidth",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.wrapper){var t=this.wrapper.getBoundingClientRect();if(e)return{width:"".concat(t.width,"px"),height:"".concat(t.height,"px")};if(t.width>t.height)return{width:"auto",height:"".concat(t.height,"px")};if(t.width<t.height)return{width:"".concat(t.width,"px"),height:"auto"}}}},{key:"calculatePos",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;if(t)e=t.getTransform();else{if(!this.zoomElement)return;e=this.zoomElement.getTransform()}var n=function(e){return Math.floor(100*e)/100};if(e){var a=e,r=a.x,i=a.y,o=a.scale;this.setState({scale:n(o)});var s=r,l=i,u=!1,h=this.wrapper.getBoundingClientRect(),c=this._video.getBoundingClientRect();if(!h)return;if(c.left>h.left&&(s=h.left,u=!0),c.top>h.top&&(l=h.top,u=!0),c.right<h.right&&(s=h.right-c.width,u=!0),c.bottom<h.bottom&&(l=h.bottom-c.height,u=!0),c.width<h.width?(s=(h.width-c.width)/2,u=!0):c.height<h.height&&(l=(h.height-c.height)/2,u=!0),u){if(n(s)===n(r)&&n(l)===n(i))return;this.zoomElement.moveTo(s,l),"flex"===this.state.wrapperDisplay&&this.setStateSafe({wrapperDisplay:"block"})}}}},{key:"resetZoom",value:function(){this.zoomElement&&(this.zoomElement.smoothZoomAbs(0,0,1),this.zoomElement.moveTo(0,0))}},{key:"refreshZoom",value:function(){this.calculatePos()}},{key:"render",value:function(){var e=this,t=this.state,n=(t.live,t.streams,t.noLive),a=t.scale,i=t.wrapperDisplay;return r.a.createElement("div",{className:"dvr-player-wrapper",ref:function(t){e.wrapper=t},style:{display:i}},r.a.createElement("div",{className:"no-live-wrapper",style:{opacity:"".concat(n?"1":"0"),fontSize:"14px"}},"NO LIVE STREAM"),!1,this.zoomElement&&1!==a?r.a.createElement("button",{className:"resetZoomBtn",onClick:this.resetZoom},r.a.createElement(z,null)):null,r.a.createElement("video",{ref:function(t){e._video=t},muted:this.props.muted,onDoubleClick:this.handleFullScreen,style:this.getWrapperWidth()}),r.a.createElement("canvas",{className:"dvr-player-snapshot",style:{display:"none"},ref:this.setSnapshotRef}))}}])&&L(n.prototype,a),i&&L(n,i),t}(a.Component);F.propTypes={returnData:l.a.func.isRequired,playback_speed:l.a.number,currentTime:l.a.oneOfType([l.a.number,l.a.string]),currentRanges:l.a.shape({brief_thumbnails:l.a.arrayOf(l.a.any),motion_log:l.a.arrayOf(l.a.any),ranges:l.a.arrayOf(l.a.shape({from:l.a.number,duration:l.a.number})),stream:l.a.string}),autoPlay:l.a.bool,muted:l.a.bool.isRequired,streamer_http:l.a.string.isRequired,name:l.a.string.isRequired,auth_token:l.a.string,paused:l.a.bool,playing:l.a.bool,debug:l.a.bool,play_duration:l.a.number,tracks:l.a.string,isStalling:l.a.bool,onPlayingChangeHandler:l.a.func,onProgress:l.a.func,onSpeedChanged:l.a.func,onStalling:l.a.func,changeUTC:l.a.func,hls:l.a.bool};k()({displayName:"SelectStream",propTypes:{onChange:l.a.func,type:l.a.string.isRequired,streams:l.a.array.isRequired,value:l.a.string},onChange:function(e){var t,n=e.target.value,a=(t=n,function(e){return e.track_id=t}),r=this.props.streams.find(a);this.props.onChange(r)},shouldComponentUpdate:function(e){return this.props.streams!==e.streams||this.props.value!==e.value},render:function(){return r.a.createElement("select",{onChange:this.onChange,value:this.props.value},r.a.createElement("option",{value:""},"no ",this.props.type),this.props.streams.map((function(e){return e.content===this.props.type?r.a.createElement("option",{key:e.track_id,value:e.track_id},(t=e.fps,n="","number"==typeof t&&(n=Number.isInteger(t)?t:t.toFixed(2),n+=" fps"),n),e.lang," ",e.bitrate," kbps"):"";var t,n})))}});var q=F,z=k()({displayName:"ResetZoomBtn",render:function(){return r.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 8.467 7.753",style:{width:"24px",height:"24px"},fill:"#fff"},r.a.createElement("defs",null),r.a.createElement("path",{d:"M7.32 7.712c-.057-.023-.533-.465-1.058-.983l-.954-.94-.198.125c-.7.444-1.668.575-2.514.34-.49-.136-1.19-.534-1.19-.678 0-.083.596-.558.7-.558.035 0 .147.048.25.107.311.18.694.278 1.081.278.67 0 1.184-.215 1.622-.682.677-.72.82-1.69.379-2.565A2.235 2.235 0 003.452.948c-.409 0-.708.076-1.08.272-.246.13-.751.574-.751.66 0 .05.245.095.52.096.223 0 .307.068.286.23-.017.13-1.63 1.655-1.75 1.655-.067 0-.213-.103-.213-.15 0-.009-.106-.47-.235-1.026-.246-1.056-.27-1.215-.184-1.3.059-.06.212-.068.272-.015.022.02.11.078.196.129l.156.093.137-.214c.239-.372.762-.824 1.21-1.045.51-.252.876-.337 1.447-.334C4.707.003 5.756.66 6.314 1.784c.257.516.331.887.308 1.542-.015.417-.04.578-.136.856l-.118.343 1.03 1.007c.9.88 1.033 1.027 1.058 1.169.105.595-.602 1.224-1.135 1.011z"}))}}),V=n(174),H=n.n(V),A=n(175),W=n.n(A);function $(e){return($="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Y(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function J(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Y(n,!0).forEach((function(t){Q(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Y(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Z(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function X(e){return(X=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function K(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function G(e,t){return(G=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Q(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ee=0,te=function(){return"".concat((new Date).getTime()).concat(ee++)},ne=function(e){function t(e){var n,a,r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),a=this,r=X(t).call(this,e),n=!r||"object"!==$(r)&&"function"!=typeof r?K(a):r,Q(K(n),"playerRef",null),Q(K(n),"getMetadata",(function(){return{width:n.state.meta.width||0,height:n.state.meta.height||0}})),Q(K(n),"setPlayerRef",(function(e){e&&!n.playerRef&&(n.playerRef=e,n.playerNode=o.a.findDOMNode(e))})),Q(K(n),"setWrapperRef",(function(e){!n.wrapperRef&&e&&(n.wrapperRef=e)})),Q(K(n),"onResize",(function(){var e=n.wrapperRef;e&&n.setState({dom:{width:e.offsetWidth,height:e.offsetHeight}})})),Q(K(n),"onRangesLoaded",(function(){})),Q(K(n),"onFlashEvent",(function(e,t){if(n.state.shouldPauseAt&&n.now()>n.state.shouldPauseAt&&n.playerRef&&n.playerRef.pause(),"ready"===e)n.play(n.state.playing_from);else if("utc"===e&&n.props.onProgress)n.props.onProgress(parseInt(t,10));else if("meta"===e)try{var a=JSON.parse(t);!a.onFI&&a.width&&n.setState({meta:a})}catch(e){console.error(e)}})),Q(K(n),"play",(function(e){e&&(n.state.playing&&n.playerRef&&n.playerNode.seek("live"===e?0:e),"live"!==e||n.now_timer||(n.now_timer=setInterval((function(){n.props.onProgress&&n.props.onProgress(n.now())}),1e3)),"live"!==e&&n.now_timer&&(clearInterval(n.now_timer),delete n.now_timer),n.setState((function(t,a){var r=t.shouldPauseAt,i=a.play_duration;return{message:"Playing from "+e,playing:!0,playing_from:e,shouldPauseAt:i?n.now()+i:r}})))})),Q(K(n),"changeSpeed",(function(e){n.playerRef&&e>=1/8&&e<=32&&(n.playerNode.setSpeed(e),n.props.onSpeedChanged&&n.props.onSpeedChanged(e))})),Q(K(n),"now",(function(){return Math.round((new Date).getTime()/1e3)}));var i=te();return n.state={message:"Waiting",id:i,meta:{width:640,height:360},dom:{},shouldPauseAt:void 0,flashVars:{streamer:n.props.streamer_rtmp,streamer_http:n.props.streamer_http,crossdomain:n.props.streamer_http+"/crossdomain.xml",stream:n.props.name+(n.props.auth_token?"?"+n.props.auth_token:""),callback:"dvr_player_status_"+i,muted:n.props.muted},speed:1},n}var n,a,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&G(e,t)}(t,e),n=t,(a=[{key:"componentDidMount",value:function(){this.onResize(),window.addEventListener("resize",this.onResize),window["dvr_player_status_"+this.state.id]=this.onFlashEvent}},{key:"componentDidUpdate",value:function(){this.state.flashVars.muted!==this.props.muted&&this.setState((function(e,t){return{flashVars:J({},e.flashVars,{muted:t.muted})}}))}},{key:"componentWillUnmount",value:function(){this.now_timer&&(clearInterval(this.now_timer),delete this.now_timer),delete window["dvr_player_status_"+this.state.id]}},{key:"render",value:function(){var e={width:100,height:100};return this.state.dom.width&&this.state.dom.height&&this.state.meta.width&&this.state.meta.height&&(this.state.dom.width/this.state.dom.height>this.state.meta.width/this.state.meta.height?(e.height=this.state.dom.height,e.width=this.state.dom.height/this.state.meta.height*this.state.meta.width):(e.width=this.state.dom.width,e.height=this.state.dom.width/this.state.meta.width*this.state.meta.height)),r.a.createElement("div",{className:"dvr-player-wrapper",ref:this.setWrapperRef},r.a.createElement(W.a,{container:r.a.createElement("div",{className:"dvr-player-wrapper2",style:e}),ref:this.setPlayerRef,src:H.a,width:this.props.style.width||e.width||window.innerWidth,height:this.props.style.height||e.height||window.innerHeight,flashVars:this.state.flashVars,wmode:"transparent",allowNetworking:"all",allowScriptAccess:"always",allowFullScreen:!0,allowFullScreenInteractive:!0}))}}])&&Z(n.prototype,a),i&&Z(n,i),t}(r.a.Component);function ae(e){return(ae="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function re(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function ie(e){return(ie=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function oe(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function se(e,t){return(se=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}Q(ne,"propTypes",{onProgress:l.a.func,onSpeedChanged:l.a.func,streamer_http:l.a.string.isRequired,streamer_rtmp:l.a.string.isRequired,name:l.a.string.isRequired,auth_token:l.a.string,play_duration:l.a.number,style:l.a.object}),Q(ne,"defaultProps",{style:{}});var le=function(e){function t(){var e,n,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=this,(e=!(a=ie(t).call(this))||"object"!==ae(a)&&"function"!=typeof a?oe(n):a).playerRef=r.a.createRef(),e.getExtraProps=e.getExtraProps.bind(oe(e)),e.state={playersComponents:{flash:ne,hls:q,mse:q}},e}var n,a,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&se(e,t)}(t,e),n=t,(a=[{key:"getExtraProps",value:function(e){var t={};switch(e){case"flash":t.player="flash",t.streamer_rtmp=this.props.streamer_rtmp;break;case"mse":t.tracks=this.props.tracks,t.currentTime=this.props.currentTime;break;case"hls":t.currentTime=this.props.currentTime,t.hls=!0}return t}},{key:"render",value:function(){var e=this.state.playersComponents,t=this.props,n=t.returnData,a=t.playback_speed,i=t.playerType,o=t.name,s=t.currentTime,l=t.autoPlay,u=t.muted,h=t.paused,c=t.auth_token,p=t.streamer_http,d=t.play_duration,m=t.debug,f=t.isStalling,g=t.onMediaInfo,v=this.getExtraProps(i),y={returnData:n,playback_speed:a,name:o,autoPlay:l,muted:u,debug:m,paused:h,auth_token:c,streamer_http:p,play_duration:d,currentTime:s,currentRanges:this.props.ranges,playing:this.props.playingStarted,isStalling:f,onMediaInfo:g,ref:this.props.setPlayerRef},b=Object.assign({},y,v);return r.a.createElement(r.a.Fragment,null,e[i]?r.a.createElement(e[i],b):r.a.createElement("div",{style:{color:"white"}}," NO PLAYER "))}}])&&re(n.prototype,a),i&&re(n,i),t}(a.Component);le.propTypes={returnData:l.a.func.isRequired,playback_speed:l.a.number,playerType:l.a.string,currentTime:l.a.oneOfType([l.a.number,l.a.string]),ranges:l.a.shape({brief_thumbnails:l.a.arrayOf(l.a.any),motion_log:l.a.arrayOf(l.a.any),ranges:l.a.arrayOf(l.a.shape({from:l.a.number,duration:l.a.number})),stream:l.a.string}),autoPlay:l.a.bool,muted:l.a.bool,name:l.a.string,isStalling:l.a.bool,debug:l.a.bool,auth_token:l.a.any,streamer_http:l.a.string,play_duration:l.a.any,paused:l.a.bool,onMediaInfo:l.a.func},le.defaultProps={playerType:"mse"};var ue=le,he=function(e,t,n,a){var r=function(e){var n=Math.max(e.from,t),a=n-t,r=e.from>t?e.duration:e.duration-(t-e.from);return{utc:n,start:a,end:a+r,duration:r}};return e.reduce((function(e,n){if(n.from+n.duration>t)if(0===e.length)e.push(r(n));else{var i=e[e.length-1],o=n.from-(i.utc+i.duration);o>=a?e.push(r(n)):(i.duration+=o+n.duration,i.end+=o+n.duration)}return e}),[])},ce={mergeRanges:function(e,t){return t},reduceRanges:function(e,t,n,a,r){if(0===a||n<10)return[];var i=Math.floor(n/a)||1,o=function(e){return Math.floor(e*a/n)},s=he(e,t,0,i);if(0===s.length)return t+n>r?[{utc:t,duration:n,left:0,type:"miss",width:o(r-t)},{utc:r,left:o(r-t),type:"live",width:o(2*n/100)}]:[{utc:t,duration:n,left:0,type:"miss",width:a}];var l=[];return s.forEach((function(e,a,i){if(0===a)e.start>0&&l.push({utc:t,duration:n,type:"miss",left:0,width:o(e.start)}),l.push({utc:e.utc,type:"hit",left:o(e.start),width:o(e.duration)});else{var s=i[a-1];l.push({utc:s.utc+s.duration,type:"miss",left:o(s.end),width:o(e.start-s.end)}),l.push({utc:e.utc,type:"hit",left:o(e.start),width:o(e.duration)})}a===i.length-1&&e.utc+e.duration<t+n&&e.utc+e.duration<r&&l.push({utc:e.utc+e.duration,type:"miss",left:o(e.end),width:o(Math.min(r,t+n)-(e.utc+e.duration))})})),t+n>r&&l.push({utc:r,type:"live",left:o(r-t),width:o(2*n/100)}),l},reduceMotion:function(e,t,n,a,r,i){var o=Math.round(i/200);return e.reduce((function(e,t){var n=0===e.length?null:e[e.length-1];return n&&t.from-(n.utc+n.width)<=o?(n.width=t.from+t.duration-n.utc,n.weight+=t.duration):e.push({utc:t.from,width:t.duration,type:"motion",weight:t.duration}),e}),[]).map((function(e){return e.opacity=Math.round(100*e.weight/e.width)/100,e.width=e.width*a/n,e.left=(e.utc-t)*a/n,e}))},_reduceSegments:he},pe=k()({displayName:"DvrSelectionBorder",className:"DvrSelectionBorder",propTypes:{position:l.a.number.isRequired,type:l.a.oneOf(["left","right"]).isRequired,onChange:l.a.func},getInitialState:function(){return{position:this.props.position}},componentWillReceiveProps:function(){this.setState({position:this.props.position})},componentWillUnmount:function(){this.unmountListeners()},unmountListeners:function(){document.removeEventListener("mousemove",this.mouse_move),document.removeEventListener("mouseup",this.mouse_up)},mouse_down:function(e){e.preventDefault(),e.stopPropagation(),this.setState({moving:!0,startX:e.pageX-this.props.position}),document.addEventListener("mousemove",this.mouse_move),document.addEventListener("mouseup",this.mouse_up)},mouse_up:function(e){e.preventDefault(e),this.setState({moving:!1}),this.unmountListeners()},mouse_move:function(e){e.preventDefault(e),this.props.onChange&&this.props.onChange(e.pageX-this.state.startX)},render:function(){var e="hidden-ios dvr-marker-drag dvr-marker-"+this.props.type;return this.state.position>=0?r.a.createElement("div",{style:{left:this.state.position},className:e,onMouseDown:this.mouse_down},r.a.createElement("svg",{width:"12",height:"20"},r.a.createElement("path",{d:"m 2,2 4,4 0,13 -4,0 z",style:{fill:"#dcdcdd",stroke:"#dcdcdd",strokeWidth:2,strokeLinejoin:"round"}}))):r.a.createElement("div",null)}}),de=k()({displayName:"DvrTimeMarkers",className:"DvrTimeMarkers",propTypes:{duration:l.a.number.isRequired,from:l.a.number,localTime:l.a.bool,width:l.a.number.isRequired},shouldComponentUpdate:function(e){return this.props.duration!==e.duration||this.props.from!==e.from||this.props.localTime!==e.localTime||this.props.width!==e.width},currentStep:function(){return this.time_unit().time},label:function(e,t){var n=new Date;n.setTime(1e3*e);var a=!1!==this.props.localTime,r=a?n.getHours():n.getUTCHours(),i=a?n.getMinutes():n.getUTCMinutes();if(t<60){var o=a?n.getSeconds():n.getUTCSeconds();return g(r)+":"+g(i)+":"+g(o)}var s=function(){return g(r)+":"+g(i)},l=function(){var e=a?n.getDate():n.getUTCDate(),t=(a?n.getMonth():n.getUTCMonth())+1;return g(a?n.getFullYear():n.getUTCFullYear())+"-"+g(t)+"-"+g(e)};return t<=3600?0===r&&0===i?l():1===r&&3600===t?"":s():t>=86400?l():r>=0&&r<Math.ceil(t/3600)?l():s()},time_units:[{name:"min1",time:60},{name:"min2",time:120},{name:"min5",time:300},{name:"min15",time:900},{name:"min30",time:1800},{name:"hour1",time:3600},{name:"hour2",time:14400},{name:"hour12",time:43200},{name:"day1",time:86400},{name:"day7",time:604800},{name:"month1",time:2592e3}],time_unit:function(){for(var e=Math.round(150*this.props.duration/this.props.width),t=1;t<this.time_units.length;t++)if(this.time_units[t].time>e||t===this.time_units.length-1)return c()(this.time_units[t-1],{$merge:{i:t-1}})},entries:function(e){for(var t=[],n=Math.floor(this.props.from/e)*e;n<=this.props.from+this.props.duration;)t.push({time:e,utc:n,label:this.label(n,e)}),n+=e;return t},timeMarkers:function(){var e=this.time_unit();return this.entries(e.time).map(function(t){var n=Math.round((t.utc-this.props.from)*this.props.width/this.props.duration);return r.a.createElement("span",{key:t.utc,style:{left:n}},this.label(t.utc,e.time))}.bind(this))},render:function(){return r.a.createElement("div",{className:"time-markers"},this.timeMarkers())}}),me=k()({displayName:"DvrRanges",className:"DvrRanges",propTypes:{left:l.a.number.isRequired,width:l.a.number.isRequired,now:l.a.number,motion:l.a.array.isRequired,ranges:l.a.array.isRequired,onUtcSeek:l.a.func,loading:l.a.bool},onscreenRangeData:function(e){var t=[];if(e){for(var n,a,r,i=e.length,o=0;o<i;o++)if(n=e[o],!((a=Math.round(n.left+this.props.left))+(r=Math.round(n.width))<=0)){if(a<0&&(r+=a,a=0),a>this.props.width)break;a+r>this.props.width&&(r=this.props.width-a);var s={left:a,utc:n.utc,width:r,type:n.type};n.opacity&&(s.opacity=n.opacity),t.push(s)}return t}},onMotionSeek:function(e){e.preventDefault(),e.stopPropagation();var t=e.target.dataset,n=t.utc,a=t.type;console.log({utc:n,type:a}),n&&this.props.onUtcSeek&&"hit"===a&&this.props.onUtcSeek(n-3)},onscreenMotion:function(){return this.onscreenRangeData(this.props.motion)},onscreenRanges:function(){return this.onscreenRangeData(this.props.ranges)},inspect:function(){for(var e=this.onscreenRanges(),t="",n=0;n<e.length;n++){var a=e[n];t+="("+a.left+","+a.type[0]+","+a.width+"),"}return t},render:function(){var e=this;return r.a.createElement("div",{className:"recorded-ranges"},r.a.createElement("div",{className:"range-wrap"},this.props.loading?r.a.createElement("div",{className:"timelineLoading"}):null,this.onscreenRanges().map((function(e,t){return r.a.createElement("div",{key:e.utc+"-"+t,className:e.type,style:{left:e.left,width:e.width}})}))),r.a.createElement("div",{className:"motion-wrap"},this.onscreenMotion().map((function(t,n){return r.a.createElement("div",{key:t.utc+"-"+n,"data-utc":t.utc,"data-type":t.type,className:t.type,onMouseDown:e.onMotionSeek,style:{left:t.left,width:t.width,opacity:t.opacity}})}))),this.props.now>0&&this.props.now<this.props.width&&r.a.createElement("div",{className:"now-marker",style:{left:this.props.now}},r.a.createElement("div",null)))}});var fe=function(e,t){var n,a,r=!1;return function i(){if(r)return n=arguments,void(a=this);e.apply(this,arguments),r=!0,setTimeout((function(){r=!1,n&&(i.apply(a,n),n=a=null)}),t)}};function ge(e){return(ge="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ve(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function ye(e){return(ye=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function be(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _e(e,t){return(_e=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Se=function(e){function t(){var e,n,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=this,(e=!(a=ye(t).call(this))||"object"!==ge(a)&&"function"!=typeof a?be(n):a).utc_change=e.utc_change.bind(be(e)),e.domSizes=e.domSizes.bind(be(e)),e.onResize=fe(e.onResize.bind(be(e)),1e3),e.afterResize1=e.afterResize1.bind(be(e)),e.loadRanges=e.loadRanges.bind(be(e)),e.refreshMotion=e.refreshMotion.bind(be(e)),e.refreshRanges=e.refreshRanges.bind(be(e)),e.reduceThumbnails=e.reduceThumbnails.bind(be(e)),e.jpeg_url=e.jpeg_url.bind(be(e)),e.onSeekTo=e.onSeekTo.bind(be(e)),e.onMotionSeek=e.onMotionSeek.bind(be(e)),e.startScrollLeft=e.startScrollLeft.bind(be(e)),e.startScrollRight=e.startScrollRight.bind(be(e)),e.stopScroll=e.stopScroll.bind(be(e)),e.scrollToPiont=e.scrollToPiont.bind(be(e)),e.startScaleIn=e.startScaleIn.bind(be(e)),e.startScaleOut=e.startScaleOut.bind(be(e)),e.stopScale=e.stopScale.bind(be(e)),e.visualTick=e.visualTick.bind(be(e)),e.scale=e.scale.bind(be(e)),e.scroll=e.scroll.bind(be(e)),e.requestAnimationFrame=e.requestAnimationFrame.bind(be(e)),e.calculateVisual=e.calculateVisual.bind(be(e)),e.changeVisual=e.changeVisual.bind(be(e)),e.recheck_borders2=e.recheck_borders2.bind(be(e)),e.now=e.now.bind(be(e)),e.now_ms=e.now_ms.bind(be(e)),e.onSelectionBorderChange=e.onSelectionBorderChange.bind(be(e)),e.onSelectionBorderChange2=e.onSelectionBorderChange2.bind(be(e)),e.selectionBorderPos=e.selectionBorderPos.bind(be(e)),e.recheckSelections=e.recheckSelections.bind(be(e)),e.toggleCalendar=e.toggleCalendar.bind(be(e)),e.onThumbnail=e.onThumbnail.bind(be(e)),e.onMouseEnter=e.onMouseEnter.bind(be(e)),e.onMouseLeave=e.onMouseLeave.bind(be(e)),e.onMouseClick=e.onMouseClick.bind(be(e)),e.onMouseMove=e.onMouseMove.bind(be(e)),e.onHoverMove=e.onHoverMove.bind(be(e)),e.onTouchLineStart=e.onTouchLineStart.bind(be(e)),e.onTouchLineMove=e.onTouchLineMove.bind(be(e)),e.onTouchLineEnd=e.onTouchLineEnd.bind(be(e)),e.controlBtn=e.controlBtn.bind(be(e)),e.setWindowRef=e.setWindowRef.bind(be(e)),e.setTimeMarkersRef=e.setTimeMarkersRef.bind(be(e)),e.state={ranges:[],motion:[],now:e.now(),visualDelay:2e3,visible_offset:0,visible_width:86400,v_duration:86400},e}var n,a,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_e(e,t)}(t,e),n=t,(a=[{key:"onChangeUtc",value:function(e){var t=this.utc_change(e,this.state);this.setState(t)}},{key:"componentDidMount",value:function(){this.props.onSelectionBorderChange&&(this.props.onSelectionBorderChange("selection_start",this.state.selection_start),this.props.onSelectionBorderChange("selection_end",this.state.selection_end));var e=86400/(this.props.zoom||1),t=(this.props.from||this.props.now||this.now())-2*e/3,n=(this.props.from||this.props.now||this.now())+1*e/3;this.setState({v_from:t,v_duration:n-t,real_from:t,real_to:n,real_duration:n-t,selection_start:t,selection_end:n-100}),this.props.returnData("observableRanges",{start:t,end:t+(n-t)}),this.recheck_borders2(this.state),this.loadRanges(this.props.range_info,this.state,this.now()),window.addEventListener("resize",this.onResize)}},{key:"componentWillUnmount",value:function(){window.removeEventListener("resize",this.onResize)}},{key:"componentWillReceiveProps",value:function(e){var t=c()(this.state,{$merge:this.loadRanges(e.range_info,this.state,this.now())}),n=c()(t,{$merge:e.utc&&e.utc!==this.state.utc||e.currentTime&&e.currentTime!==this.props.currentTime?this.utc_change(e.utc,t):{}});this.setState(n),this.onResize()}},{key:"componentDidUpdate",value:function(e,t){if(this.state.v_from!==t.v_from||this.state.v_duration!==t.v_duration){var n=this.props.observableRanges.start,a=this.props.observableRanges.end,r=!1;this.state.v_from<n&&(n=this.state.v_from,r=!0),this.state.v_from+this.state.v_duration>a&&(a=this.state.v_from+this.state.v_duration,r=!0),r&&this.props.returnData("observableRanges",{start:n,end:a})}}},{key:"utc_change",value:function(e,t){if(!e)return{};var n=Math.round((e-t.v_from)*t.visible_width/t.v_duration),a={};n!==t.play_progress&&(a.play_progress=n),e!==t.utc&&(a.utc=e);var r=!0;(this.state.scrolling||this.state.scroll_ended_at&&this.now_ms()-this.state.scroll_ended_at<this.state.visualDelay)&&(r=!1),(this.state.scaleing||this.state.scale_ended_at&&this.now_ms()-this.state.scale_ended_at<this.state.visualDelay)&&(r=!1);var i={showBackToCursor:!1};return r&&(e<=t.v_from||e>=t.v_from+t.v_duration)&&(i={showBackToCursor:!0}),c()(a,{$merge:i})}},{key:"domSizes",value:function(){if(!this.windowRef)return!1;var e={},t=this.windowRef,n=t.getBoundingClientRect();if(e.window_width=n.width,n.width||n.height){var a=t.ownerDocument,r=a.documentElement,i=a.defaultView;e.window_left=n.left+i.pageXOffset-r.clientLeft}return e}},{key:"onResize",value:function(){if(this.domSizes()){var e={visible_width:this.domSizes().window_width},t=c()(this.state,{$merge:e}),n=this.afterResize1(t),a=c()(t,{$merge:n}),r=[e,n,this.refreshRanges(a.segments,a,this.now()),this.refreshMotion(a.motion_data,a,this.now())].reduce((function(e,t){return c()(e,{$merge:t})}),e);this.setState(r)}}},{key:"afterResize1",value:function(e){return void 0!==e.v_from&&void 0!==e.real_from?{visible_offset:Math.round(-(e.v_from-e.real_from)*e.visible_width/e.v_duration),wrapper_width:Math.round(e.real_duration*e.visible_width/e.v_duration)}:{visible_offset:0,wrapper_width:0}}},{key:"loadRanges",value:function(e,t,n){if(!e)return{};if(e.loaded_at===t.range_loaded_at)return{};var a=e.motion.map((function(e){return e})),r=e.ranges.map((function(e){return e}));r.push({from:n,duration:5,meta:"pseudolive"});var i=this.refreshRanges(r,t,n),o=c()(t,{$merge:i}),s=this.reduceThumbnails(e.brief_thumbnails,o),l=c()(i,{$merge:s}),u=c()(l,{$merge:{range_loaded_at:e.loaded_at}});return c()(u,{$merge:this.refreshMotion(a,o,n)})}},{key:"refreshMotion",value:function(e,t,n){return e?{motion_data:e,motion:ce.reduceMotion(e,t.real_from,t.real_duration,t.wrapper_width,n,t.v_duration)}:{}}},{key:"refreshRanges",value:function(e,t,n){return e?{segments:e,ranges:ce.reduceRanges(e,t.real_from,t.real_duration,t.wrapper_width,n)}:{}}},{key:"reduceThumbnails",value:function(e){if(!e)return{thumbnails:{}};var t={jpegs:{},utcs:{}},n=this.state.visible_width||600;t.step=10*this.state.v_duration/n;for(var a=0;a<e.length;a++){var r=Math.floor(e[a]/t.step);t.jpegs[r]||(t.jpegs[r]=this.jpeg_url(e[a]),t.utcs[r]=e[a])}return{thumbnails:t}}},{key:"jpeg_url",value:function(e){var t=new Date;return t.setTime(1e3*e),this.props.http_stream_url+"/"+t.getUTCFullYear()+"/"+pad2(t.getUTCMonth()+1)+"/"+pad2(t.getUTCDate())+"/"+pad2(t.getUTCHours())+"/"+pad2(t.getUTCMinutes())+"/"+pad2(t.getUTCSeconds())+".jpg"+(this.props.auth_token?"?"+this.props.auth_token:"")}},{key:"onSeekTo",value:function(e){if(!this.props.loading){var t=this.domSizes(),n=(e-t.window_left)/t.window_width,a=!1,r=Math.round(n*this.state.v_duration+this.state.v_from),i=this.props.range_info.ranges;r>this.now()?this.props.onSeek("live"):(S.isInRange(r,i)||(r=S.getNearLeftFrom(r,i),a=!0),r===this.props.currentTime&&(a=!0),this.props.onSeek(r,a))}}},{key:"onMotionSeek",value:function(e){this.props.onSeek&&this.props.onSeek(e)}},{key:"startScrollLeft",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];!t&&e.preventDefault(),this.setState({scrolling:"left",scroll_count:0,scroll_step:Math.round(.01*this.state.v_duration),started:this.now_ms(),start_from:this.state.v_from}),this.requestAnimationFrame(this.visualTick),t&&setTimeout(this.stopScroll,300)}},{key:"startScrollRight",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];!t&&e.preventDefault(),this.setState({scrolling:"right",scroll_count:0,scroll_step:Math.round(.01*this.state.v_duration),started:this.now_ms(),start_from:this.state.v_from}),this.requestAnimationFrame(this.visualTick),t&&setTimeout(this.stopScroll,300)}},{key:"stopScroll",value:function(){this.setState({scrolling:void 0,scroll_count:void 0,scroll_step:void 0,scroll_ended_at:this.now_ms()})}},{key:"scrollToPiont",value:function(e){this.setState({scrolling:"toPoint",scroll_count:0,goUtc:e,scroll_ended_at:e}),this.toPoint=e,this.requestAnimationFrame(this.visualTick)}},{key:"startScaleOut",value:function(e,t){!t&&e.preventDefault(),this.setState({scaling:"out",scale_count:0,started:this.now_ms()}),this.requestAnimationFrame(this.visualTick),t&&setTimeout(this.stopScale,300)}},{key:"startScaleIn",value:function(e,t){!t&&e.preventDefault(),this.setState({scaling:"in",scale_count:0,started:this.now_ms()}),this.requestAnimationFrame(this.visualTick),t&&setTimeout(this.stopScale,300)}},{key:"stopScale",value:function(){this.setState({scaling:void 0,scale_ended_at:this.now_ms()})}},{key:"visualTick",value:function(){var e=this.now_ms();"left"===this.state.scrolling&&(this.setState({scroll_count:this.state.scroll_count+1}),this.scroll(this.state.start_from-this.state.scroll_step*(e-this.state.started)/20)),"right"===this.state.scrolling&&(this.setState({scroll_count:this.state.scroll_count+1}),this.scroll(this.state.start_from+this.state.scroll_step*(e-this.state.started)/20)),this.toPoint&&(this.scroll(this.toPoint-this.state.v_duration/2),this.toPoint=void 0),"out"===this.state.scaling&&this.scale(1.02),"in"===this.state.scaling&&this.scale(.98),(this.state.scrolling||this.state.scaling)&&this.requestAnimationFrame(this.visualTick)}},{key:"scale",value:function(e){if(this.state.real_from&&this.state.real_duration&&!(e<=0||e<1&&this.state.real_duration*e<1e3||e>1&&this.state.real_duration*e>2592e3)){var t=this.state.v_duration,n={v_from:((this.state.utc>this.state.v_from+t/10&&this.state.utc<this.state.v_from+.9*t?this.state.utc:this.state.v_from+this.state.v_duration/2)-this.state.v_from)*(1-e)+this.state.v_from,v_duration:e*this.state.v_duration};this.changeVisual(n)}}},{key:"scroll",value:function(e){this.changeVisual({v_from:e})}},{key:"requestAnimationFrame",value:function(e){(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)})(e)}},{key:"calculateVisual",value:function(e,t){var n=c()(e,{$merge:t}),a=this.recheck_borders2(n),r=c()(n,{$merge:a}),i=this.afterResize1(r),o=c()(r,{$merge:i}),s=this.utc_change(o.utc,o),l=c()(o,{$merge:s}),u=this.refreshRanges(l.segments,l,this.now()),h=c()(l,{$merge:u}),p=this.recheckSelections(h),d=c()(h,{$merge:p}),m=this.refreshMotion(d.motion_data,d,this.now());return c()(d,{$merge:m}),function(e){for(var t={},n=0;n<e.length;n++)t=c()(t,{$merge:e[n]});return t}([t,a,i,s,u,p,m])}},{key:"changeVisual",value:function(e){var t=this.calculateVisual(this.state,e);c()(this.state,{$merge:t}),this.setState(t)}},{key:"recheck_borders2",value:function(e){var t=e.v_from-e.real_from,n=e.real_to-(e.v_from+e.v_duration),a={too_few_left:[-t/e.v_duration,-.3],too_few_right:[-n/e.v_duration,-.3],too_much_left:[t/e.v_duration,1.3],too_much_right:[n/e.v_duration,1.3]};for(var r in a)if(a.hasOwnProperty(r)&&a[r][0]>a[r][1])return{real_from:e.v_from-Math.round(2.4*e.v_duration/3),real_duration:2.4*e.v_duration,real_to:e.v_from+Math.round(4.8*e.v_duration/3)};return{}}},{key:"now",value:function(){return Math.round(this.now_ms()/1e3)}},{key:"now_ms",value:function(){return Math.round((new Date).getTime())}},{key:"onSelectionBorderChange",value:function(e,t){var n=Math.round(t*this.state.v_duration/this.state.visible_width+this.state.v_from),a=this.onSelectionBorderChange2(e,n,this.state);this.setState(a)}},{key:"onSelectionBorderChange2",value:function(e,t,n){var a={},r=t;return r>n.v_from+n.v_duration&&(r=n.v_from+n.v_duration),r<n.v_from&&(r=n.v_from),"selection_start"===e&&r>n.selection_end&&n.selection_end>n.v_from&&(r=n.selection_end),"selection_end"===e&&r<n.selection_start&&n.selection_start<n.v_from+n.v_duration&&(r=n.selection_start),a[e]=r,this.props.onSelectionBorderChange&&this.props.onSelectionBorderChange(e,r),a}},{key:"selectionBorderPos",value:function(e){return Math.round((this.state[e]-this.state.v_from)*this.state.visible_width/this.state.v_duration)}},{key:"recheckSelections",value:function(e){var t={},n={},a=e.v_duration/20;return e.selection_start<e.v_from+a?t=this.onSelectionBorderChange2("selection_start",e.v_from,e):e.selection_start>e.v_from+e.v_duration-a/2&&(t=this.onSelectionBorderChange2("selection_start",e.v_from,e)),e.selection_end>e.v_from+e.v_duration-a/2?n=this.onSelectionBorderChange2("selection_end",e.v_from+e.v_duration,e):e.selection_end<e.v_from+a&&(n=this.onSelectionBorderChange2("selection_end",e.v_from+e.v_duration,e)),c()(t,{$merge:n})}},{key:"toggleCalendar",value:function(e){e.preventDefault(),this.state.calendarOpened?this.setState({calendarOpened:!1}):this.setState({calendarOpened:!0}),this.props.onCalendarToggle&&this.props.onCalendarToggle(!this.state.calendarOpened)}},{key:"onThumbnail",value:function(e,t,n){this.props.onThumbnail&&this.props.onThumbnail(e,t,n,this.state.visible_width)}},{key:"onMouseEnter",value:function(e){return this.setState({over_timeline:!0,thumbnail_url:void 0}),this.onHoverMove(e.pageX)}},{key:"onMouseLeave",value:function(){this.setState({over_timeline:!1,thumbnail_url:void 0}),this.onThumbnail("clear")}},{key:"onMouseClick",value:function(e){e.target!==this.backBtnRef&&(e.preventDefault(),this.onSeekTo(e.pageX))}},{key:"onMouseMove",value:function(e){return this.onHoverMove(e.pageX)}},{key:"onHoverMove",value:function(e){if(this.state.over_timeline&&this.state.visible_width){var t=e-this.domSizes().window_left,n=Math.round(this.state.v_from+this.state.v_duration*t/this.state.visible_width);!function(e,t){if(!e)return!1;for(var n=0;n<e.length;n++){if(t<e[n].from)return!1;if(t<e[n].from+e[n].duration)return!0}return!1}(this.state.segments,n)?this.onThumbnail("clear"):this.props.is_mobile?this.onThumbnail("canvas",n,t):this.onThumbnail("video",n,t)}}},{key:"onTouchLineStart",value:function(e){e.preventDefault(),this.setState({over_timeline:!0,thumbnail_url:void 0}),this.onThumbnail("clear"),this.last_touch_x=e.nativeEvent.touches[0].pageX}},{key:"onTouchLineMove",value:function(e){e.preventDefault(),this.onHoverMove(e.touches[0].pageX),this.last_touch_x=e.touches[0].pageX}},{key:"onTouchLineEnd",value:function(e){e.preventDefault(),this.setState({over_timeline:!1,thumbnail_url:void 0}),this.onThumbnail("clear"),this.onSeekTo(this.last_touch_x),delete this.last_touch_x}},{key:"controlBtn",value:function(e,t,n){var a="btn btn-xs "+e;return r.a.createElement("button",{onMouseDown:t,onTouchStart:t,onMouseUp:n,onTouchEnd:n,type:"button",className:a},r.a.createElement("span",{className:"icon"}))}},{key:"setWindowRef",value:function(e){!this.windowRef&&e&&(this.windowRef=e)}},{key:"setTimeMarkersRef",value:function(e){!this.timeMarkersRef&&e&&(this.timeMarkersRef=e)}},{key:"render",value:function(){return r.a.createElement("div",{ref:this.setWindowRef,className:"timeline__timelineView",onMouseDown:this.onMouseClick,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,onMouseMove:this.onMouseMove,onTouchStart:this.onTouchLineStart,onTouchMove:this.onTouchLineMove,onTouchEnd:this.onTouchLineEnd},this.state.visible_width&&r.a.createElement(de,{ref:this.setTimeMarkersRef,from:this.state.v_from,duration:this.state.v_duration,width:this.state.visible_width,localTime:this.props.localTime}),this.state.visible_width&&r.a.createElement(me,{ranges:this.state.ranges,motion:this.state.motion,debug:this.props.debug,left:this.state.visible_offset,width:this.state.visible_width,now:this.state.play_progress,onUtcSeek:this.onMotionSeek,loading:this.props.loading}),!this.props.is_mobile&&r.a.createElement(pe,{onChange:this.onSelectionBorderChange.bind(this,"selection_start"),type:"left",position:Math.round((this.state.selection_start-this.state.v_from)*this.state.visible_width/this.state.v_duration)}),!this.props.is_mobile&&r.a.createElement(pe,{onChange:this.onSelectionBorderChange.bind(this,"selection_end"),type:"right",position:Math.round((this.state.selection_end-this.state.v_from)*this.state.visible_width/this.state.v_duration)}),this.props.debug&&r.a.createElement("div",{style:{color:"white"}},"v_from: ",this.state.v_from,", v_duration: ",this.state.v_duration,", v_to: ",this.state.v_from+this.state.v_duration,", sel:"," ",this.state.selection_start-this.state.v_from," -"," ",this.state.selection_end-this.state.v_from,", marker_step:"," ",this.timeMarkersRef&&this.timeMarkersRef.currentStep(),", jpeg:"," ",this.state.thumbnail_url))}}])&&ve(n.prototype,a),i&&ve(n,i),t}(a.Component);Se.propTypes={utc:l.a.any,onRangesRequested:l.a.func,onSeek:l.a.func,onCalendarToggle:l.a.func,onThumbnail:l.a.func,thumbnails_enabled:l.a.bool,onSelectionBorderChange:l.a.func,locale:l.a.oneOf(["ru","en"]),from:l.a.number,now:l.a.oneOfType([l.a.string,l.a.number]),range_info:l.a.object,zoom:l.a.number,debug:l.a.bool,localTime:l.a.bool,is_mobile:l.a.bool,http_stream_url:l.a.string,auth_token:l.a.string,currentTime:l.a.any,playerUtc:l.a.number,returnData:l.a.func,observableRanges:l.a.shape({start:l.a.number,end:l.a.number}),loading:l.a.bool},Se.defaultProps={};var Te=Se,we=k()({displayName:"DvrDownloadControl",className:"DvrDownloadControl",propTypes:{url:l.a.string.isRequired,start:l.a.number.isRequired,stop:l.a.number.isRequired,auth_token:l.a.string,localTime:l.a.bool,locale:l.a.oneOf(["ru","en"])},download_mp4_url:function(){return this.props.url+"/archive-"+this.props.start+"-"+(this.props.stop-this.props.start)+".mp4"+(this.props.auth_token?"?"+this.props.auth_token:"")},humanTime:function(e){if(!(e>0))return"";var t=new Date;t.setTime(1e3*e);var n=!(!1===this.props.localTime),a=n?t.getHours():t.getUTCHours(),r=n?t.getMinutes():t.getUTCMinutes(),i=n?t.getSeconds():t.getUTCSeconds();return g(a)+":"+g(r)+":"+g(i)},render:function(){return r.a.createElement("div",{className:"control"},r.a.createElement("a",{className:"download",href:this.download_mp4_url(),target:"_blank"},"ru"===this.props.locale?"Скачать":"MP4"),"ru"===this.props.locale&&r.a.createElement("div",{className:"download-text"},"архив записи с ",this.humanTime(this.props.start)," по  ",this.humanTime(this.props.stop)),"ru"!==this.props.locale&&r.a.createElement("div",{className:"download-text"},this.humanTime(this.props.start)," -"," ",this.humanTime(this.props.stop)))}}),ke=k()({displayName:"DvrThumbnail",className:"DvrThumbnail",propTypes:{thumbnail:l.a.shape({type:l.a.oneOf(["image","video","canvas"]).isRequired,utc:l.a.number.isRequired,position:l.a.number.isRequired,visibleWidth:l.a.number.isRequired}),media:l.a.shape({width:l.a.number,height:l.a.number}).isRequired,streamUrl:l.a.string.isRequired,authToken:l.a.string,thumbnailsEnabled:l.a.bool},getInitialState:function(){var e=this.props.media;return 0!==e.width&&0!==e.height?{height:160,width:Math.floor(160*e.width/e.height)}:{}},utcToPath:function(e){var t=new Date(1e3*e);return d("{year}/{month}/{day}/{hours}/{minutes}/{seconds}",{year:t.getUTCFullYear(),month:g(t.getUTCMonth()+1),day:g(t.getUTCDate()),hours:g(t.getUTCHours()),minutes:g(t.getUTCMinutes()),seconds:g(t.getUTCSeconds())})},humanify:function(e){return y(e)+" "+v(e)},buildSourceUrl:function(e,t){var n=this.props.authToken?"?"+this.props.authToken:"";return d("{streamUrl}/{path}{postfix}{authToken}",{streamUrl:this.props.streamUrl,path:this.utcToPath(e),postfix:"video"===t&&!1===this.props.thumbnailsEnabled?"-preview.mp4":".jpg",authToken:n})},captureImageFromVideo:function(){var e=this.refs.thumbnailCapturer,t=this.refs.videoThumbnail,n=e.getContext("2d"),a=t.videoWidth,r=t.videoHeight;e.width=a,e.height=r,n.fillRect(0,0,a,r),n.drawImage(t,0,0,a,r)},setThumbnailCapturerRef:function(e){!this.thumbnailCapturer&&e&&(this.thumbnailCapturer=e)},setVideoThumbnailRef:function(e){!this.videoThumbnail&&e&&(this.videoThumbnail=e)},render:function(){this.props.media;var e=this.props.thumbnail,t=e.type,n=e.utc,a=e.position,i=e.visibleWidth,o={height:this.state.height};this.state.width&&(o.width=this.state.width);var s={left:a};if(document.getElementById("thumbnailVideo")&&document.getElementById("thumbnailVideo").videoHeight){var l=document.getElementById("thumbnailVideo").videoHeight/document.getElementById("thumbnailVideo").videoWidth;if(document.getElementById("thumbnailVideo").videoHeight*l<=160)o={height:document.getElementById("thumbnailVideo").videoHeight*l,width:document.getElementById("thumbnailVideo").videoWidth*l};else{var u=160/document.getElementById("thumbnailVideo").videoHeight;o={height:document.getElementById("thumbnailVideo").videoHeight*u,width:document.getElementById("thumbnailVideo").videoWidth*u}}}return a+213>i&&(s.transform="translateX(-100%)"),r.a.createElement("div",{style:s,className:"timeline__thumbnail"},"video"===t&&!1===this.props.thumbnailsEnabled&&r.a.createElement("video",{autoPlay:!0,className:"timeline__thumbnail__image",style:o,id:"thumbnailVideo",src:this.buildSourceUrl(n,t)}),"image"===t||!0===this.props.thumbnailsEnabled&&r.a.createElement("img",{className:"timeline__thumbnail__image",style:{height:this.state.height},src:this.buildSourceUrl(n,t)}),"canvas"===t&&r.a.createElement("canvas",{className:"timeline__thumbnail__image",ref:this.setThumbnailCapturerRef,style:o}),"canvas"===t&&r.a.createElement("video",{autoPlay:!0,ref:this.setVideoThumbnailRef,onLoadedData:this.captureImageFromVideo,className:"timeline__thumbnail__hidden",style:o,src:this.buildSourceUrl(n,"video")}),r.a.createElement("span",{className:"timeline__thumbnail__caption"},this.humanify(n)))}}),Ee=k()({displayName:"DvrSnapshotControl",className:"DvrSnapshotControl",propTypes:{onTakeSnapshotClick:l.a.func.isRequired,locked:l.a.bool},render:function(){return r.a.createElement("button",{className:"btn",onClick:this.props.onTakeSnapshotClick},r.a.createElement("span",{className:"icon ".concat(this.props.locked?" locked":"")}))}}),Re=k()({displayName:"DvrCalendar",className:"DvrCalendar",propTypes:{now:l.a.number.isRequired,currentTime:l.a.oneOfType([l.a.number,l.a.string]).isRequired,locale:l.a.oneOf(["ru","en"]),onChange:l.a.func.isRequired,toggleCalendar:l.a.func.isRequired,returnData:l.a.func.isRequired,ranges:l.a.shape({brief_thumbnails:l.a.arrayOf(l.a.any),motion_log:l.a.arrayOf(l.a.any),ranges:l.a.arrayOf(l.a.shape({from:l.a.number,duration:l.a.number})),stream:l.a.string})},day_utc:function(e){var t=new Date;return t.setTime(1e3*e),t.setUTCHours(0),t.setUTCMinutes(0),t.setUTCSeconds(0),t.setUTCMilliseconds(0),Math.ceil(t.getTime()/1e3)},getInitialState:function(){return{month:this.props.now,ranges:{}}},componentDidMount:function(){this.props.now&&this.getMonthRanges()},componentDidUpdate:function(e,t){t.month!==this.state.month&&this.getMonthRanges()},prevMonth:function(e){e.preventDefault();var t=new Date;t.setTime(1e3*this.state.month),0===t.getUTCMonth()?(t.setUTCFullYear(t.getUTCFullYear()-1),t.setUTCMonth(11)):t.setUTCMonth(t.getUTCMonth()-1),this.setState({month:Math.round(t.getTime()/1e3)})},nextMonth:function(e){e.preventDefault();var t=new Date;t.setTime(1e3*this.state.month),11===t.getUTCMonth()?(t.setUTCFullYear(t.getUTCFullYear()+1),t.setUTCMonth(1)):t.setUTCMonth(t.getUTCMonth()+1),this.setState({month:Math.round(t.getTime()/1e3)})},months:{ru:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Нов","Дек"],en:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]},days:{ru:["пн","вт","ср","чт","пт","сб","вс"],en:["mo","tu","we","th","fr","sa","su"]},displayMonth:function(e){var t=new Date;return t.setTime(1e3*e),this.months[this.props.locale||"en"][t.getMonth()]},displayYear:function(e){var t=new Date;return t.setTime(1e3*e),t.getFullYear()},dayNames:function(){for(var e=this.days[this.props.locale||"en"],t=[],n=0;n<21;n++)t.push(r.a.createElement("div",{className:"day-name",key:n},e[n%e.length]));return t},dayEntries:function(e){var t=new Date;t.setTime(1e3*this.state.month);var n=this.props.currentTime,a=t.getMonth(),i=(t.getDate(),[]);this.props.ranges&&this.props.ranges.ranges&&this.props.ranges.ranges.length&&(i=this.props.ranges.ranges.map((function(e){return{start:e.from,end:e.from+e.duration}}))),t.setDate(1);var o=t.getDay();t.setTime(t.getTime()-864e5*(o-1));for(var s=t.getTime(),l=[],u=function(){if("live"===n)return!1;var e=new Date(1e3*n);return t.getDate()===e.getDate()&&t.getMonth()===e.getMonth()&&t.getFullYear()===e.getFullYear()},h=0;h<21;h++){t.setTime(s+86400*(21*e+h)*1e3);var c="day-entry "+(t.getMonth()===a?"current-month ":"other-month ")+(t.getUTCDate()===(new Date).getUTCDate()&&t.getUTCMonth()===(new Date).getUTCMonth()&&t.getUTCFullYear()===(new Date).getUTCFullYear()?"current-day ":u()?"selected-day ":"other-day "),p=b(t.getTime()/1e3),d=this.findDayRangesIntersection(p,i),m=null;if(d){var f=new Date(1e3*d.start);m=[f.getUTCFullYear(),f.getUTCMonth(),f.getUTCDate(),f.getUTCHours(),f.getUTCMinutes(),f.getUTCSeconds()]}var g=!!d;l.push(r.a.createElement("div",{className:"".concat(c).concat(g?"avaible":""),key:"".concat(h,"_").concat(t.getDate(),"_").concat(JSON.stringify(m)),onClick:g?this.selectDay.bind(this,m):null},t.getDate()))}return l},findDayRangesIntersection:function(e,t){for(var n=!1,a=0;a<t.length&&!(n=_(e,t[a]));a++);return n},selectDay:function(e,t){t.preventDefault();var n=new Date;n.setTime(1e3*this.state.month),n.setUTCFullYear(e[0]),n.setUTCMonth(e[1]),n.setUTCDate(e[2]),n.setUTCHours(e[3]),n.setUTCMinutes(e[4]),n.setUTCSeconds(e[5]),this.props.onChange(Math.round(n.getTime()/1e3))},getMonthRanges:function(){var e=this.state.month,t=new Date,n=new Date;t.setTime(1e3*e),n=new Date(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate()),t.setDate(1),n.setDate(0),t.setHours(0,0,0),n.setHours(0,0,0),e&&this.props.returnData("observableRanges",{end:Math.round(n.getTime()/1e3),start:Math.round(t.getTime()/1e3)})},render:function(){return r.a.createElement("div",{className:"calendar"},r.a.createElement("div",{onClick:this.prevMonth,className:"month-change month-prev"},r.a.createElement("a",{href:"#"})),r.a.createElement("div",{className:"month"},this.displayMonth(this.state.month),r.a.createElement("br",null),r.a.createElement("span",{className:"year"},this.displayYear(this.state.month))),r.a.createElement("div",{onClick:this.nextMonth,className:"month-change month-next"},r.a.createElement("a",{href:"#"})),r.a.createElement("div",{className:"days"},r.a.createElement("div",{className:"day-names"},this.dayNames()),r.a.createElement("div",{className:"clear"}),r.a.createElement("div",{className:"day-entries"},this.dayEntries(0)),r.a.createElement("div",{className:"clear"}),r.a.createElement("div",{className:"day-entries"},this.dayEntries(1)),r.a.createElement("div",{className:"calendar_close",onClick:this.props.toggleCalendar},"×")))}});function Me(e){return(Me="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ce(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function De(e){return(De=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Pe(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Oe(e,t){return(Oe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ue=function(e){function t(){var e,n,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=this,(e=!(a=De(t).call(this))||"object"!==Me(a)&&"function"!=typeof a?Pe(n):a).onRangesLoaded=e.onRangesLoaded.bind(Pe(e)),e.onSelectionBorderChange=e.onSelectionBorderChange.bind(Pe(e)),e.onThumbnail=e.onThumbnail.bind(Pe(e)),e.faster=e.faster.bind(Pe(e)),e.slower=e.slower.bind(Pe(e)),e.toggleCalendar=e.toggleCalendar.bind(Pe(e)),e.calendarDayChanged=e.calendarDayChanged.bind(Pe(e)),e.controlBtn=e.controlBtn.bind(Pe(e)),e.startScaleIn=e.startScaleIn.bind(Pe(e)),e.startScaleOut=e.startScaleOut.bind(Pe(e)),e.stopScale=e.stopScale.bind(Pe(e)),e.startScrollLeft=e.startScrollLeft.bind(Pe(e)),e.startScrollRight=e.startScrollRight.bind(Pe(e)),e.stopScroll=e.stopScroll.bind(Pe(e)),e.scrollToPiont=e.scrollToPiont.bind(Pe(e)),e.handlePause=e.handlePause.bind(Pe(e)),e.setDvrTimelineRef=e.setDvrTimelineRef.bind(Pe(e)),e.onTakeSnapshotStarted=e.onTakeSnapshotStarted.bind(Pe(e)),e.onTakeSnapshotFinished=e.onTakeSnapshotFinished.bind(Pe(e)),e.onTakeSnapshotClick=e.onTakeSnapshotClick.bind(Pe(e)),e.state={ranges:[],range_info:{ranges:[],motion:[]},calendarOpened:!1,hourFormat:"HH:mm:ss",takingSnapshot:!1,utc:null},e}var n,a,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Oe(e,t)}(t,e),n=t,(a=[{key:"componentDidMount",value:function(){var e=this;this.setState({hourFormat:!1===this.props.localTime?"UU:mm:ss":"HH:mm:ss"}),document.addEventListener("keydown",(function(t){"Space"===t.code&&e.handlePause(),"ArrowUp"===t.code&&e.scrollToPiont(),"NumpadAdd"!==t.code&&"Equal"!==t.code||e.startScaleIn(null,!0),"NumpadSubtract"!==t.code&&"Minus"!==t.code||e.startScaleOut(null,!0),!t.ctrlKey||"ArrowRight"!==t.code&&39!==t.which||e.startScrollRight(null,!0),!t.ctrlKey||"ArrowLeft"!==t.code&&37!==t.which||e.startScrollLeft(null,!0)}))}},{key:"componentWillReceiveProps",value:function(e){var t=this.props.ranges;JSON.stringify(t)!==JSON.stringify(e.ranges)&&this.onRangesLoaded(e.ranges),this.props.forceScrollToPoint&&(this.scrollToPiont(),this.props.returnData("forceScrollToPoint",!1))}},{key:"componentWillUnmount",value:function(){document.removeEventListener("keyup")}},{key:"onRangesLoaded",value:function(e){var t=ce.mergeRanges(this.state.range_info.ranges,e.ranges),n=(e.motion_log||[]).filter((function(e){return"motion"===e.type&&"range"===e.subtype&&!!e.data})).map((function(e){return{from:e.data.start||e.at,duration:e.data.duration||10}})),a=ce.mergeRanges(this.state.range_info.motion,n),r=[];Array.prototype.push.apply(r,this.state.range_info.brief_thumbnails),Array.prototype.push.apply(r,e.brief_thumbnails),r.sort();for(var i=0;i<r.length-1;)r[i]===r[i+1]?r.splice(i,1):i++;var o=c()(this.state.range_info,{ranges:{$set:t},motion:{$set:a},brief_thumbnails:{$set:r},loaded_at:{$set:this.now_ms()}});this.setState({range_info:o})}},{key:"now",value:function(){return Math.round(this.now_ms()/1e3)}},{key:"now_ms",value:function(){return Math.round((new Date).getTime())}},{key:"faster",value:function(e){e.preventDefault(),this.props.changeSpeed(2*(this.props.playback_speed||1))}},{key:"slower",value:function(e){e.preventDefault(),this.props.changeSpeed(.5*(this.props.playback_speed||1))}},{key:"onSelectionBorderChange",value:function(e,t){var n={};n[e]=t,this.setState(n)}},{key:"toggleCalendar",value:function(e){e.preventDefault(),this.state.calendarOpened?this.setState({calendarOpened:!1}):this.setState({calendarOpened:!0}),this.props.onCalendarToggle&&this.props.onCalendarToggle(!this.state.calendarOpened)}},{key:"calendarDayChanged",value:function(e){var t=this.state,n=(t.selection_end-t.selection_start)/2;this.setState({selection_start:e-n,selection_end:e+n}),this.scrollToPiont(e),this.props.returnData("currentTime",e)}},{key:"startScaleIn",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this&&this.dvrTimelineRef)return this.dvrTimelineRef.startScaleIn(e,t)}},{key:"startScaleOut",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this&&this.dvrTimelineRef)return this.dvrTimelineRef.startScaleOut(e,t)}},{key:"stopScale",value:function(){if(this&&this.dvrTimelineRef)return this.dvrTimelineRef.stopScale()}},{key:"startScrollLeft",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this&&this.dvrTimelineRef)return this.dvrTimelineRef.startScrollLeft(e,t)}},{key:"startScrollRight",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this&&this.dvrTimelineRef)return this.dvrTimelineRef.startScrollRight(e,t)}},{key:"stopScroll",value:function(e){if(this&&this.dvrTimelineRef)return this.dvrTimelineRef.stopScroll(e)}},{key:"scrollToPiont",value:function(e){var t=e||this.props.playerProgressTime;if(this&&this.dvrTimelineRef)return this.dvrTimelineRef.scrollToPiont(t)}},{key:"handlePause",value:function(){this.props.returnData("paused",!this.props.paused)}},{key:"controlBtn",value:function(e,t,n){var a="btn btn-xs "+e;return r.a.createElement("button",{onMouseDown:t,onTouchStart:t,onMouseUp:n,onTouchEnd:n,type:"button",className:a},r.a.createElement("span",{className:"icon"}))}},{key:"onThumbnail",value:function(e,t,n,a){this.setState({thumbnail:{utc:t,type:e,position:n,visibleWidth:a}})}},{key:"onTakeSnapshotStarted",value:function(){this.setState({takingSnapshot:!0})}},{key:"onTakeSnapshotFinished",value:function(){this.setState({takingSnapshot:!1})}},{key:"onTakeSnapshotClick",value:function(){this.props.onTakeSnapshotClick(this.onTakeSnapshotStarted,this.onTakeSnapshotFinished)}},{key:"setDvrTimelineRef",value:function(e){!this.dvrTimelineRef&&e&&(this.dvrTimelineRef=e)}},{key:"render",value:function(){var e=this,t=this.state.thumbnail&&this.state.thumbnail.position,n=S.humanTime,a=S.humanDate,i=S.currentUrl(window.document.location.href,{from:Math.round(this.props.playerProgressTime)});return r.a.createElement("div",{className:"dvr-timeline"},r.a.createElement("div",{className:"timeline",onWheel:function(t){return t.deltaY<0?e.startScaleIn(t,!0):t.deltaY>0?e.startScaleOut(t,!0):e.stopScale()}},this.props.DVR&&r.a.createElement(Te,{ref:this.setDvrTimelineRef,onSeek:this.props.onSeek,from:this.props.from,now:this.props.now,zoom:this.props.zoom,utc:this.props.now,debug:this.props.debug,onSelectionBorderChange:this.onSelectionBorderChange,thumbnails_enabled:this.props.thumbnails_enabled,onRangesRequested:this.props.onRangesRequested,onThumbnail:this.onThumbnail,range_info:this.state.range_info,is_mobile:this.props.is_mobile,auth_token:this.props.auth_token,http_stream_url:this.props.http_stream_url,currentTime:this.props.currentTime,returnData:this.props.returnData,observableRanges:this.props.observableRanges,loading:this.props.loading}),this.state.thumbnail&&this.state.thumbnail.utc&&r.a.createElement(ke,{thumbnail:this.state.thumbnail,media:this.props.onMetadataRequest(),streamUrl:this.props.http_stream_url,authToken:this.props.auth_token,thumbnailsEnabled:this.props.thumbnails_enabled}),t>0&&r.a.createElement("div",{className:"timeLineCursor",style:{left:t+"px"}}),this.props.DVR&&r.a.createElement("button",{style:{marginRight:"8px",padding:"0"},className:"btn btn-xs",onClick:this.handlePause,type:"button"},r.a.createElement(xe,{paused:this.props.paused})),this.props.DVR&&r.a.createElement("button",{style:{marginRight:"16px",padding:"0"},className:"btn btn-xs",onClick:function(){return e.scrollToPiont()},type:"button"},r.a.createElement(je,null)),this.props.DVR&&this.controlBtn("btn--leftmost  timeline__zoomoutControl",this.startScaleOut,this.stopScale),this.props.DVR&&this.controlBtn("btn--rightmost timeline__zoominControl",this.startScaleIn,this.stopScale),this.props.DVR&&this.controlBtn("btn--leftmost  timeline__seekLeftControl",this.startScrollLeft,this.stopScroll),this.props.DVR&&this.controlBtn("btn--rightmost timeline__seekRightControl",this.startScrollRight,this.stopScroll),r.a.createElement("button",{style:{marginLeft:"".concat(this.props.DVR?"20px":"0"),padding:"0"},className:"btn btn-xs",onClick:this.props.onToggleMuted,type:"button"},r.a.createElement(Le,{muted:this.props.muted})),this.props.DVR&&r.a.createElement("div",{className:"timeline__speedControls".concat(this.props.live?" hidden":"")},r.a.createElement("button",{className:"btn btn--leftmost timeline__speedControls__slower",onClick:this.slower,title:"Slower"},r.a.createElement("span",{className:"icon"})),r.a.createElement("div",{className:"timeline__speedControls__currentSpeed"},"x",this.props.playback_speed),r.a.createElement("button",{className:"btn btn--rightmost timeline__speedControls__faster",onClick:this.faster,title:"Faster"},r.a.createElement("span",{className:"icon"}))),this.props.playerProgressTime&&r.a.createElement("div",{className:"timeline__timeControl"},r.a.createElement("a",{className:"timeline__timeControl__current",href:i},n(this.props.playerProgressTime))),this.props.DVR&&r.a.createElement("div",{className:"btn timeline__calendarControl".concat(this.props.now?"":" inactive"),onClick:this.toggleCalendar},r.a.createElement("div",{className:"timeline__calendar__current"},a("live"!==this.props.currentTime?this.props.currentTime:this.now()))),r.a.createElement("div",{className:"timeline__downloadControls"},!this.props.is_mobile&&this.props.http_stream_url&&this.props.DVR&&r.a.createElement(we,{name:this.props.name,url:this.props.http_stream_url,auth_token:this.props.auth_token,start:Math.round(this.state.selection_start),stop:Math.round(this.state.selection_end),locale:this.props.locale})),r.a.createElement("div",{className:"timeline__snapshotControl"},!this.props.is_mobile&&this.props.http_stream_url&&("mse"===this.props.player&&!this.props.live||"dash"===this.props.player)&&r.a.createElement(Ee,{onTakeSnapshotClick:this.onTakeSnapshotClick,locked:this.state.takingSnapshot})),r.a.createElement("div",{className:"timeline__calendarContent"},this.state.calendarOpened&&this.props.now?r.a.createElement(Re,{now:this.props.now,currentTime:this.props.currentTime,onChange:this.calendarDayChanged,locale:this.props.locale,toggleCalendar:this.toggleCalendar,returnData:this.props.returnData,ranges:this.state.range_info}):null)))}}])&&Ce(n.prototype,a),i&&Ce(n,i),t}(a.Component);Ue.propTypes={playerProgressTime:l.a.oneOfType([l.a.string,l.a.number]),ranges:l.a.shape({brief_thumbnails:l.a.arrayOf(l.a.any),motion_log:l.a.arrayOf(l.a.any),ranges:l.a.arrayOf(l.a.shape({from:l.a.number,duration:l.a.number})),stream:l.a.string}),observableRanges:l.a.shape({start:l.a.number,end:l.a.number}),returnData:l.a.func,live:l.a.bool,muted:l.a.bool,thumbnails_enabled:l.a.bool,changeSpeed:l.a.func,playback_speed:l.a.number,locale:l.a.oneOf(["ru","en"]),from:l.a.number,now:l.a.oneOfType([l.a.string,l.a.number]),zoom:l.a.number,debug:l.a.bool,localTime:l.a.bool,is_mobile:l.a.bool,http_stream_url:l.a.string,player:l.a.string,name:l.a.string,auth_token:l.a.string,onMetadataRequest:l.a.func,onToggleMuted:l.a.func,onMetadataRequst:l.a.func,onTakeSnapshotClick:l.a.func,onSeek:l.a.func,onStop:l.a.func,onCalendarToggle:l.a.func,currentTime:l.a.any,loading:l.a.bool,DVR:l.a.bool,paused:l.a.bool,activeSegment:l.a.number},Ue.defaultProps={};var Ne=Ue,Le=k()({displayName:"MutedBtn",className:"MutedBtn",render:function(){var e={display:"inline-block",width:"30px",height:"30px"};return this.props.muted?r.a.createElement("i",{style:e},r.a.createElement("svg",{fill:"#fff",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16"},r.a.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M9.75 11.51L6.7 9.5H3.75v-3H6.7L9.75 4.49v.664l.497.498V3.498L6.547 6H3.248v4h3.296l3.7 2.502v-2.154l-.497.5v.662zm3-5.165L12.404 6l-1.655 1.653L9.093 6l-.346.345L10.402 8 8.747 9.654l.346.347 1.655-1.653L12.403 10l.348-.346L11.097 8l1.655-1.655z"}))):r.a.createElement("i",{style:e},r.a.createElement("svg",{fill:"#fff",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16"},r.a.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M11.5 11h-.002v1.502L7.798 10H4.5V6h3.297l3.7-2.502V4.5h.003V11zM11 4.49L7.953 6.5H5v3h2.953L11 11.51V4.49z"})))}}),xe=k()({displayName:"PlayBtn",className:"PlayBtn",render:function(){var e={display:"inline-block",width:"30px",height:"30px"};return this.props.paused?r.a.createElement("i",{style:e},r.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1",id:"Capa_1",x:"0px",y:"0px",viewBox:"0 0 415.346 415.346",fill:"#fff",style:{width:"18px",height:"30px"}},r.a.createElement("g",null,r.a.createElement("g",null,r.a.createElement("path",{d:"M41.712,415.346c-11.763,0-21.3-9.537-21.3-21.3V21.299C20.412,9.536,29.949,0,41.712,0l346.122,191.697    c0,0,15.975,15.975,0,31.951C371.859,239.622,41.712,415.346,41.712,415.346z"})),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null)),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null))):r.a.createElement("i",{style:e},r.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1",id:"Capa_1",x:"0px",y:"0px",viewBox:"0 0 535.578 535.578",fill:"#fff",style:{width:"18px",height:"30px"}},r.a.createElement("g",null,r.a.createElement("g",null,r.a.createElement("g",null,r.a.createElement("path",{d:"M231.6,516.278c0,10.658-8.641,19.3-19.3,19.3H106.15c-10.659,0-19.3-8.641-19.3-19.3V19.3     c0-10.659,8.641-19.3,19.3-19.3h106.15c10.659,0,19.3,8.641,19.3,19.3V516.278z"}),r.a.createElement("path",{d:"M448.728,516.278c0,10.658-8.641,19.3-19.3,19.3h-106.15c-10.659,0-19.3-8.641-19.3-19.3V19.3     c0-10.659,8.641-19.3,19.3-19.3h106.15c10.659,0,19.3,8.641,19.3,19.3V516.278z"}))),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null)),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null),r.a.createElement("g",null)))}}),je=k()({displayName:"FocusBtn",className:"FocusBtn",render:function(){return r.a.createElement("i",{style:{display:"inline-block",width:"30px",height:"30px"}},r.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1",x:"0px",y:"0px",viewBox:"0 0 1000 1000",fill:"#fff",style:{width:"18px",height:"30px"}},r.a.createElement("g",null,r.a.createElement("path",{d:"M898.9,557.6c-25.3,176.6-164.8,316-341.3,341.4v91H442.4v-91.1c-176.6-25.3-316-164.8-341.4-341.3H10V442.4h91c25.3-176.5,164.8-316,341.4-341.3V10h115.3v91.1c176.6,25.3,316,164.8,341.4,341.3h91v115.3H898.9z M557.6,199.9c0,0,0,18.2,0,40.7c0,31.8-25.8,57.6-57.6,57.6c-31.9,0-57.6-25.8-57.6-57.6c0-22.5,0-40.7,0-40.7c-122.6,23.5-219.1,120-242.5,242.5c0,0,18.2,0,40.7,0c31.8,0,57.6,25.8,57.6,57.6s-25.8,57.6-57.6,57.6c-22.5,0-40.7,0-40.7,0c23.4,122.5,119.9,219.1,242.5,242.5c0,0,0-18.2,0-40.7c0-31.8,25.8-57.6,57.6-57.6c31.8,0,57.6,25.8,57.6,57.6c0,17,0,40.7,0,40.7c122.5-23.4,219-119.9,242.5-242.5c0,0-18.2,0-40.7,0c-31.8,0-57.6-25.8-57.6-57.6c0-31.9,25.8-57.6,57.6-57.6c22.5,0,40.7,0,40.7,0C776.7,319.8,680.2,223.3,557.6,199.9z"}))))}});n(529);function Ie(e){return(Ie="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Be(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function Fe(e){return(Fe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function qe(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ze(e,t){return(ze=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ve(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var He=function(e){function t(){var e,n,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=this,a=Fe(t).call(this),e=!a||"object"!==Ie(a)&&"function"!=typeof a?qe(n):a,Ve(qe(e),"setStateSafe",(function(){for(var t,n,a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];return e.isUnmounted?(n=console).log.apply(n,["DVRPlayer's setState called for unmounted component with args: "].concat(r)):(t=e).setState.apply(t,r)})),e.timeline=e.timeline.bind(qe(e)),e.returnData=e.returnData.bind(qe(e)),e.fetchRanges=fe(e.fetchRanges.bind(qe(e)),1e3),e.fetchLiveRecordingStatus=e.fetchLiveRecordingStatus.bind(qe(e)),e.updateRanges=e.updateRanges.bind(qe(e)),e.onTimelineSeek=e.onTimelineSeek.bind(qe(e)),e.changeSpeed=e.changeSpeed.bind(qe(e)),e.onMetadataRequest=e.onMetadataRequest.bind(qe(e)),e.onTakeSnapshotClick=e.onTakeSnapshotClick.bind(qe(e)),e.setPlayerRef=e.setPlayerRef.bind(qe(e)),e.handleToggleMuted=e.handleToggleMuted.bind(qe(e)),e.checkSegment=e.checkSegment.bind(qe(e)),e.state={calendarFull:!1,playingStarted:!1,showPlayButton:!1,is_mobile:!1,player:"mse",playback_speed:1,paused:!1,live:!0,ranges:void 0,isStalling:!0,currentTime:null,muted:!0,playerProgressTime:null,observableRanges:{},DVR:!1,forceScrollToPoint:!1},e}var n,a,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ze(e,t)}(t,e),n=t,(a=[{key:"componentWillMount",value:function(){this.props.from?this.fetchRanges(this.props.from-300,S.now()+300):this.fetchLiveRecordingStatus()}},{key:"componentDidMount",value:function(){var e=window.navigator.userAgent;-1!==e.indexOf("Android")||-1!==e.indexOf("AppleWebKit")&&-1===e.indexOf("Chrome")?this.setStateSafe({player:"hls"}):"MediaSource"in window?this.setStateSafe({player:"mse"}):S.isFlashAvailable()&&this.setStateSafe({player:"flash"}),"hls"===this.props.proto&&this.setStateSafe({player:"hls"}),"rtmp"===this.props.proto&&this.setStateSafe({player:"flash"}),"mse"===this.props.proto&&this.setStateSafe({player:"mse"}),-1!==e.indexOf("iPad")||-1!==e.indexOf("iPhone")||-1!==e.indexOf("Android")?this.setStateSafe({is_mobile:!0}):this.setStateSafe({is_mobile:!1}),this.props.from?(this.setStateSafe({currentTime:this.props.from,live:!1}),this.fetchRanges(this.props.from-300,S.now()+300)):this.setStateSafe({currentTime:"live",live:!0}),this.props.autoPlay||this.setStateSafe({showPlayButton:!0}),this.activeSegment=null}},{key:"componentDidUpdate",value:function(e,t){var n=this.state,a=n.observableRanges,r=n.playerProgressTime,i=n.currentTime,o=n.DVR,s=n.ranges;if(JSON.stringify(t.observableRanges)!==JSON.stringify(a)&&o&&this.fetchRanges(a.start,a.end),i&&!r&&s&&s.ranges){var l=i;S.isInRange(i,s.ranges)||(l=S.getNearLeftFrom(i,s.ranges)),this.setStateSafe({currentTime:l,playerProgressTime:"live"===l?S.now():l,forceScrollToPoint:!0,isStalling:!1})}else t.playerProgressTime&&t.playerProgressTime!==r&&(this.setState({isStalling:!1}),this.fetchRanges(a.start,a.end),"live"!==i&&null!==this.activeSegment&&s.ranges&&s.ranges[this.activeSegment+1]&&r>=s.ranges[this.activeSegment].from+s.ranges[this.activeSegment].duration&&Math.round(t.playerProgressTime)!==t.currentTime&&Math.round(r)!==i&&t.currentTime===i&&(this.setStateSafe({currentTime:s.ranges[this.activeSegment+1].from,forceScrollToPoint:!0,isStalling:!1}),this.activeSegment=null),this.setStateSafe({isStalling:!1}))}},{key:"returnData",value:function(e,t){this.setStateSafe(Ve({},e,t))}},{key:"fetchLiveRecordingStatus",value:function(){var e=S.now();this.fetchRanges(e-300,e+300)}},{key:"fetchRanges",value:function(e,t){var n=this;if(!this.isRSFetching){var a=S.setMinimalRange(e,t),r=a.from,i=a.to;(Number.isNaN(r)||Number.isNaN(i))&&(r=915130800,i=1893438e3);var o=this.props.streamer_http+"/"+this.props.name+"/recording_status.json?from="+Math.round(e)+"&to="+Math.round(t)+"&request=motion_log,ranges"+(this.props.auth_token?"&"+this.props.auth_token:"");return fetch(o,{method:"get",credentials:"same-origin"}).then((function(e){if(200!==e.status){var t=new Error(e.status);throw t.response=e,t}return e.json()})).then((function(e){if(e[0]&&(!e[0].error||"no_dvr"!==e[0].error))return n.setStateSafe({DVR:!0}),n.updateRanges(e[0]),e;e[0].error&&"no_dvr"===e[0].error&&n.setStateSafe({DVR:!1})})).catch((function(e){throw new Error(e)}))}console.warn("fetching recording_status in progress. Interput fetchRequest")}},{key:"updateRanges",value:function(e){var t=e.ranges,n=this.state.ranges&&this.state.ranges.ranges||[],a=S.mergeRanges(t,n),r=Object.assign({},e,{ranges:a});this.checkSegment(void 0,r),this.setStateSafe({ranges:r})}},{key:"checkSegment",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,n=arguments.length>1?arguments[1]:void 0,a=n.ranges||this.state.ranges,r=t||this.state.playerProgressTime;a&&a.forEach((function(t,n){t.from&&t.duration&&r&&r>=t.from&&r<=t.from+t.duration&&(e.activeSegment=n)}))}},{key:"onMetadataRequest",value:function(){var e=this.playerRef;return e?e.getMetadata():{width:0,height:0}}},{key:"onTakeSnapshotClick",value:function(e,t){var n=this.playerRef;e(),n&&n.takeSnapshot().then(t,t)}},{key:"onTimelineSeek",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e;"live"===this.state.currentTime&&n===this.state.currentTime||(t&&this.playerRef.startByTimePlayback(n),this.setStateSafe({currentTime:n}))}},{key:"changeSpeed",value:function(e){e>=1/8&&e<32&&this.setStateSafe({playback_speed:e})}},{key:"handleStalling",value:function(e){this.setStateSafe({isStalling:e})}},{key:"handleToggleMuted",value:function(){this.setStateSafe({muted:!this.state.muted})}},{key:"setPlayerRef",value:function(e){this.playerRef=e}},{key:"timeline",value:function(){var e=r.a.createElement(Ne,{name:this.props.name,muted:this.state.muted,thumbnails_enabled:this.props.thumbnails_enabled,playback_speed:this.state.playback_speed,locale:this.props.locale,from:this.props.from,zoom:this.props.zoom,player:this.state.player,debug:this.props.debug,is_mobile:this.state.is_mobile,http_stream_url:this.props.streamer_http+"/"+this.props.name,auth_token:this.props.auth_token,changeSpeed:this.changeSpeed,onToggleMuted:this.handleToggleMuted,onMetadataRequest:this.onMetadataRequest,onSeek:this.onTimelineSeek,onCalendarToggle:this.onCalendarToggle,onTakeSnapshotClick:this.onTakeSnapshotClick,currentTime:this.state.currentTime,playerProgressTime:this.state.playerProgressTime,now:this.state.playerProgressTime,ranges:this.state.ranges,observableRanges:this.state.observableRanges,returnData:this.returnData,live:this.state.live,loading:this.state.isStalling,DVR:this.state.DVR,paused:this.state.paused,forceScrollToPoint:this.state.forceScrollToPoint,activeSegment:this.activeSegment});return this.props.timeLineElement?Object(i.createPortal)(e,this.props.timeLineElement):e}},{key:"render",value:function(){var e=this.state,t=e.ranges,n=e.currentTime,a=e.muted,i=e.playback_speed,o=r.a.createElement(ue,{returnData:this.returnData,playerType:this.state.player,currentTime:n,name:this.props.name,muted:a,auth_token:this.props.auth_token,play_duration:this.props.play_duration,tracks:this.props.tracks,streamer_http:this.props.streamer_http,streamer_rtmp:this.props.streamer_rtmp,playback_speed:i,ranges:t,debug:this.props.debug,setPlayerRef:this.setPlayerRef,paused:this.state.paused,isStalling:this.state.isStalling,onMediaInfo:this.props.onMediaInfo});return this.props.timeline_first?r.a.createElement("div",{className:"dvr-player"},this.timeline(),r.a.createElement("div",{className:"clear"}),o,r.a.createElement("div",{className:"Loading".concat(this.state.isStalling?"visible":"")},r.a.createElement(T,null))):r.a.createElement("div",{className:"dvr-player"},o,this.timeline(),r.a.createElement("div",{className:"Loading".concat(this.state.isStalling?"visible":"")},r.a.createElement(T,null)))}}])&&Be(n.prototype,a),o&&Be(n,o),t}(a.Component);He.propTypes={proto:l.a.string,from:l.a.number,play_duration:l.a.number,streamer_http:l.a.string,streamer_rtmp:l.a.string,thumbnails_enabled:l.a.bool,auth_token:l.a.string,autoPlay:l.a.bool,locale:l.a.oneOf(["ru","en"]),name:l.a.string,zoom:l.a.number,debug:l.a.bool,timeline_first:l.a.bool,tracks:l.a.string,timeLineElement:l.a.object,onStalling:l.a.func,onMediaInfo:l.a.func},He.defaultProps={autoPlay:!0,timelineElement:void 0};var Ae=He;Ae.load=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,a={timeLineElement:n};if(e.query){var o=Object(u.decode)(e.query.replace(/^\?/,"")),s=e.auth_token_name||o.auth_token_name;s&&o[s]&&(a.auth_token=s+"="+encodeURIComponent(o[s])),o.play_duration&&parseInt(o.play_duration)>0&&(a.play_duration=parseInt(o.play_duration)),o.locale&&(a.locale=o.locale),o.track&&(a.track=o.track),o.from&&parseInt(o.from)>0&&(a.from=parseInt(o.from)),o.zoom&&parseInt(o.zoom)>0&&(a.zoom=parseInt(o.zoom)),(o.auto_play||o.autoplay||o.autoPlay)&&(a.autoPlay="true"==o.autoplay||"true"==o.autoPlay||"yes"==o.autoPlay),o.debug&&(a.debug=!0),o.name&&(a.name=o.name),o.auth_token_name&&(a.auth_token_name=o.auth_token_name),o.host&&(a.streamer_http=o.host),o.muted&&(a.muted=o.muted)}var l=c()(e,{$merge:a});l.thumbnails_enabled||(l.thumbnails_enabled=!1),Object(i.render)(r.a.createElement(Ae,l),t)};t.default=Ae}},[[530,1,2]]])}));